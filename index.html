<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Calculator - Pediatric | ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Inter', sans-serif;
    }
    
    .gradient-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab5 100%);
    }
    
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .input-focus:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: #3b82f6;
    }
    
    .section-title {
      position: relative;
      padding-left: 12px;
    }
    
    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #3b82f6, #1d4ed8);
      border-radius: 2px;
    }
    
    .result-highlight {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-left: 4px solid #0ea5e9;
    }
    
    .warning-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
    }
    
    .success-box {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-left: 4px solid #10b981;
    }
    
    .table-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    }
    
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    .radio-custom:checked + label {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .checkbox-custom:checked + label {
      background-color: #10b981;
      color: white;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    .print-section {
      display: none;
    }
    
    @media print {
      .no-print {
        display: none !important;
      }
      .print-section {
        display: block !important;
      }
      body {
        font-size: 12pt;
      }
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .tab-button.inactive {
      background-color: white;
      color: #6b7280;
      border-color: #e5e7eb;
    }

    .page-hidden {
      display: none !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="gradient-header text-white py-4 px-6 sticky top-0 z-50 shadow-lg no-print">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
     <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
       <svg class="w-8 h-8" fill="currentColor" viewbox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z" />
       </svg>
      </div>
      <div>
       <h1 id="appTitle" class="text-xl font-bold tracking-tight">TPN Calculator - Pediatric</h1>
       <p id="hospitalName" class="text-blue-100 text-sm">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</p>
      </div>
     </div>
     <div class="flex items-center gap-2"><button id="historyBtn" onclick="goToHistory()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm"> üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á TPN </button> <button onclick="resetForm()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm"> üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï </button> <button onclick="window.print()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm"> ÔøΩÔøΩÔ∏è ‡∏û‡∏¥‡∏°‡∏û‡πå </button>
     </div>
    </div>
   </header><!-- Main Content -->
   <main id="mainContent" class="max-w-6xl mx-auto p-4 md:p-6 space-y-6"><!-- Order Date & Patient Info -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏πÔøΩÔøΩ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><!-- Order Date -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order TPN</label> <input type="date" id="orderDate" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all bg-white">
      </div><!-- HN -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">HN (‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ)</label> <input type="text" id="hn" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå HN" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" autofocus>
      </div><!-- Patient Name -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-ÔøΩÔøΩ‡∏≤ÔøΩÔøΩÔøΩ‡∏™‡∏Å‡∏∏‡∏•</label> <input type="text" id="patientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ÔøΩÔøΩÔøΩ‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
      </div><!-- Ward -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Ward</label> <input type="text" id="ward" placeholder="‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πàÔøΩÔøΩÔøΩ‡∏¢" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
      </div>
     </div>
    </section><!-- Route Selection -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">ü©∫ Route ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ TPN</h2>
     <div class="flex flex-wrap gap-3"><input type="radio" name="route" id="central" value="central" class="hidden radio-custom" checked> <label for="central" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2"> <span class="text-xl">üîµ</span> Central Line </label> <input type="radio" name="route" id="peripheral" value="peripheral" class="hidden radio-custom"> <label for="peripheral" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2"> <span class="text-xl">üü¢</span> Peripheral Line </label>
     </div>
    </section><!-- Basic Info -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">‚öñÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (BW)</label>
       <div class="relative"><input type="number" id="bw" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">kg</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Total TPN Volume (‡∏£‡∏ß‡∏° Fat)</label>
       <div class="relative"><input type="number" id="totalVolume" step="1" min="0" placeholder="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
       </div>
      </div>
     </div>
    </section><!-- Fat Configuration -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üßà ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Fat ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ</label>
       <div class="relative"><input type="number" id="fatTarget" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-24" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Net Fat ‡∏™ÔøΩÔøΩ‡∏ó‡∏ò‡∏¥</label>
       <div class="relative"><input type="number" id="netFat" step="0.1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-blue-50 pr-24 font-semibold text-blue-700" readonly inputmode="decimal"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Fat Volume</label>
       <div class="relative"><input type="number" id="fatVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Vitalipid-N Infant</label>
       <div class="relative"><input type="number" id="vitalipid" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
       </div>
      </div>
     </div>
     <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-xl border border-amber-200"><input type="checkbox" id="deductVitalipid" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" onchange="calculateAll()"> <label for="deductVitalipid" class="text-sm text-gray-700 cursor-pointer select-none"> <span class="font-medium">‡∏´‡∏±‡∏Å Fat ‡∏à‡∏≤‡∏Å Vitalipid</span> <span class="text-amber-600">(0.4 g/kg/day)</span> </label>
     </div>
    </section><!-- PN Volume & Rate -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíß PN Volume &amp; Rate</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">PN Volume (Total - Fat - Vitalipid)</label>
       <div class="relative"><input type="number" id="pnVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 bg-green-50 font-semibold text-green-700" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Rate TPN (PN Volume √∑ 24)</label>
       <div class="relative"><input type="number" id="rateTPN" step="0.01" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-blue-50 pr-16 font-semibold text-blue-700" readonly inputmode="decimal"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml/hr</span>
       </div>
      </div>
     </div>
    </section><!-- Macronutrient -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">ü•ó Macronutrient</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Protein</label>
       <div class="relative"><input type="number" id="proteinTarget" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-24" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Fat (Net Fat)</label>
       <div class="relative"><input type="number" id="fatDisplay" step="0.1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-100 pr-24 font-semibold text-gray-600" readonly inputmode="decimal"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
       </div>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-1">%Dextrose</label>
       <div class="relative"><input type="number" id="dextrosePercent" step="0.1" min="0" max="50" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
       </div>
      </div>
     </div><!-- GIR Display -->
     <div id="girContainer" class="p-4 rounded-xl result-highlight">
      <div class="flex items-center justify-between">
       <div class="flex items-center gap-2"><span class="text-2xl">üìä</span>
        <div><span class="text-sm text-gray-600">GIR (Glucose Infusion Rate)</span>
         <p class="text-xs text-gray-500 mt-0.5">= (Rate TPN √ó %Dextrose) √∑ (BW √ó 6)</p>
        </div>
       </div>
       <div class="text-right"><span id="girValue" class="text-2xl font-bold text-blue-700">0.00</span> <span class="text-gray-600 ml-1">mg/kg/min</span>
       </div>
      </div>
      <div id="girWarning" class="hidden mt-2 text-sm text-amber-700 bg-amber-100 px-3 py-2 rounded-lg">
       ‚ö†Ô∏è GIR ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏õ‡∏Å‡∏ï‡∏¥ 4-6 mg/kg/min ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏öÔøΩÔøΩÔøΩ‡∏≤‡∏£‡∏Å, 2-4 mg/kg/min ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡πÇÔøΩÔøΩ)
      </div>
     </div>
    </section><!-- Product Selection -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üß¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Protein Product -->
      <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
       <h3 class="font-semibold text-purple-800 mb-3 flex items-center gap-2"><span>ü•©</span> Protein Product</h3>
       <div class="space-y-2"><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300"> <input type="radio" name="proteinProduct" value="aminoven" class="mt-1" checked onchange="calculateAll()">
         <div><span class="font-medium text-gray-800">10% Aminoven¬Æ Infant</span>
          <p class="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ 0-1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
         </div></label> <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300"> <input type="radio" name="proteinProduct" value="amiparen" onchange="calculateAll()">
         <div><span class="font-medium text-gray-800">10% Amiparen¬Æ</span>
          <p class="text-xs text-gray-500">ÔøΩÔøΩ‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ &gt; 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
         </div></label> <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300"> <input type="radio" name="proteinProduct" value="aminoplasmal" onchange="calculateAll()">
         <div><span class="font-medium text-gray-800">15% Aminoplasmal¬Æ</span>
          <p class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°ÔøΩÔøΩÔøΩ‡∏Ç‡πâ‡∏°‡∏Ç‡πâÔøΩÔøΩ‡∏™‡∏π‡∏á (‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)</p>
         </div></label>
       </div>
      </div><!-- Fat Product -->
      <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
       <h3 class="font-semibold text-amber-800 mb-3 flex items-center gap-2"><span>üßà</span> Fat Product</h3>
       <div class="space-y-2"><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-amber-100 transition-all border border-transparent hover:border-amber-300"> <input type="radio" name="fatProduct" value="smof" class="mt-1" checked onchange="calculateAll()">
         <div><span class="font-medium text-gray-800">20% SMOF Lipid</span>
          <p class="text-xs text-gray-500">Mixed lipid emulsion</p>
         </div></label> <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-amber-100 transition-all border border-transparent hover:border-amber-300"> <input type="radio" name="fatProduct" value="intralipid" onchange="calculateAll()">
         <div><span class="font-medium text-gray-800">20% Intralipid</span>
          <p class="text-xs text-gray-500">Soybean oil emulsion</p>
         </div></label>
       </div>
      </div>
     </div>
    </section><!-- Electrolytes Section -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">‚öóÔ∏è Electrolytes</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"><!-- Phosphorus -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">P (Glycophos¬Æ)</label>
       <p class="text-xs text-gray-600 mb-2">0.5-1 mEq/kg/day</p>
       <div class="relative mb-2"><input type="number" id="phosphorus" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
       </div>
       <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
        <p class="text-gray-700"><strong>Vol:</strong> <span id="phosvol">0.0</span> ml</p>
        <p class="text-gray-700"><strong>Na from P:</strong> <span id="phoNa">0</span> mEq</p>
       </div>
      </div><!-- Sodium -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Na (3% NaCl)</label>
       <p class="text-xs text-gray-600 mb-2">2-4 mEq/kg/day</p>
       <div class="relative mb-2"><input type="number" id="sodium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
       </div>
       <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
        <p class="text-gray-700"><strong>Vol:</strong> <span id="navol">0.0</span> ml</p>
       </div>
      </div><!-- Potassium -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">K (KCl)</label>
       <p class="text-xs text-gray-600 mb-2">2-4 mEq/kg/day</p>
       <div class="relative mb-2"><input type="number" id="potassium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
       </div>
       <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
        <p class="text-gray-700"><strong>Vol:</strong> <span id="kvol">0.0</span> ml</p>
       </div>
      </div><!-- Magnesium -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Mg (50% MgSO‚ÇÑ)</label>
       <p class="text-xs text-gray-600 mb-2">0.2-0.3 mmol/kg/day</p>
       <div class="relative mb-2"><input type="number" id="magnesium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
       </div>
       <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
        <p class="text-gray-700"><strong>Vol:</strong> <span id="mgvol">0.0</span> ml</p>
       </div>
      </div><!-- Calcium -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">Ca (10% Ca Gluconate)</label>
       <p class="text-xs text-gray-600 mb-2">4-6 ml/kg/day</p>
       <div class="relative mb-2"><input type="number" id="calcium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
       </div>
       <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
        <p class="text-gray-700"><strong>Vol:</strong> <span id="cavol">0.0</span> ml</p>
       </div>
      </div>
     </div>
    </section><!-- Vitamins & Trace Elements Section -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíä Vitamin &amp; Trace Elements</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><!-- Vitamin -->
      <div class="p-4 bg-green-50 rounded-xl border border-green-200">
       <h3 class="font-semibold text-green-800 mb-3">üíâ Vitamin</h3>
       <div class="space-y-3">
        <div><label class="text-sm font-medium text-gray-700 block mb-1">Soluvit¬Æ N</label>
         <div class="flex items-center gap-2"><input type="number" id="soluvit" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" readonly inputmode="decimal"> <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
         </div>
         <p class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 10 ml)</p>
         <p id="soluvitWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô 10 ml!</p>
        </div>
       </div>
      </div><!-- Trace Elements -->
      <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200">
       <h3 class="font-semibold text-cyan-800 mb-3">üî¨ Trace Elements</h3>
       <div class="space-y-3">
        <div><label class="text-sm font-medium text-gray-700 block mb-1">Peditrace¬Æ</label>
         <div class="flex items-center gap-2"><input type="number" id="peditrace" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" readonly inputmode="decimal"> <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
         </div>
         <p class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 15 ml)</p>
         <p id="peditraceWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô 15 ml!</p>
        </div>
       </div>
      </div>
     </div>
    </section><!-- Additive Section -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üß™ Additive</h2>
     <div class="space-y-6"><!-- Preterm & Zinc -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
       <div class="p-4 bg-orange-50 rounded-xl border border-orange-200">
        <h3 class="font-semibold text-orange-800 mb-3 flex items-center gap-2"><input type="checkbox" id="isPreterm" class="w-5 h-5 rounded cursor-pointer" onchange="calculateAll()"> <label for="isPreterm" class="cursor-pointer">Preterm infant</label></h3>
        <div id="zincOptions" class="space-y-3 hidden"><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-orange-100 border border-transparent hover:border-orange-300"> <input type="radio" name="zinc" value="yes" class="mt-1" onchange="calculateAll()">
          <div class="flex-1"><span class="font-medium text-gray-800 block">Add Zinc Sulfate</span>
           <p class="text-xs text-gray-600">500 mcg/ml = 0.3 ml √ó BW</p>
          </div></label>
         <div id="zincVolumeDiv" class="hidden ml-8 p-3 bg-white rounded-lg"><label class="block text-sm font-medium text-gray-700 mb-2">Zinc Volume</label>
          <div class="relative"><input type="number" id="zincVolume" step="0.01" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml</span>
          </div>
         </div><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-orange-100 border border-transparent hover:border-orange-300"> <input type="radio" name="zinc" value="no" class="mt-1" onchange="calculateAll()"> <span class="font-medium text-gray-800">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° Zinc</span> </label>
        </div>
       </div><!-- Heparin -->
       <div class="p-4 bg-pink-50 rounded-xl border border-pink-200">
        <h3 class="font-semibold text-pink-800 mb-3">üíâ Heparin</h3>
        <div class="space-y-3"><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-pink-100 border border-transparent hover:border-pink-300"> <input type="radio" name="heparin" value="yes" id="heparinYes" class="mt-1" onchange="calculateAll()">
          <div class="flex-1"><span class="font-medium text-gray-800 block">‡πÄ‡∏ï‡∏¥‡∏° Heparin</span>
           <p class="text-xs text-gray-600">1 unit/ml = 1 √ó PN volume</p>
          </div></label>
         <div id="heparinValueDiv" class="hidden ml-8 p-3 bg-white rounded-lg">
          <div class="flex items-center gap-2 mb-2"><span class="text-sm font-medium text-gray-700">Heparin Units:</span> <span id="heparinUnits" class="text-lg font-bold text-pink-700">0</span> <span class="text-gray-600">units</span>
          </div>
          <div class="flex items-center gap-2"><span class="text-sm font-medium text-gray-700">Heparin Volume:</span> <span id="heparinVolume" class="text-lg font-bold text-pink-700">0.00</span> <span class="text-gray-600">ml (√∑ 500)</span>
          </div>
         </div><label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-pink-100 border border-transparent hover:border-pink-300"> <input type="radio" name="heparin" value="no" class="mt-1" checked onchange="calculateAll()"> <span class="font-medium text-gray-800">‡πÑ‡∏°‡πàÔøΩÔøΩÔøΩÔøΩÔøΩ‡∏ï‡∏¥‡∏° Heparin</span> </label>
        </div>
       </div>
      </div><!-- Add Other -->
      <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
       <h3 class="font-semibold text-purple-800 mb-3">‚ûï Add ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</label> <input type="text" id="additiveOtherName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Taurine, L-Carnitine" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" oninput="calculateAll()">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£</label>
         <div class="relative"><input type="number" id="additiveOtherVolume" step="0.1" min="0" placeholder="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()"> <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
         </div>
        </div>
       </div>
      </div>
     </div>
    </section><!-- Composition Table -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìä ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö TPN</h2>
     <div class="overflow-x-auto rounded-xl border border-gray-200">
      <table class="w-full text-sm">
       <thead>
        <tr class="table-header text-white">
         <th class="px-4 py-3 text-left font-semibold rounded-tl-xl">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠ÔøΩÔøΩÔøΩ</th>
         <th class="px-4 py-3 text-right font-semibold">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</th>
         <th class="px-4 py-3 text-right font-semibold">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µÔøΩÔøΩÔøΩ (kcal)</th>
         <th class="px-4 py-3 text-right font-semibold rounded-tr-xl">mOsmol/L</th>
        </tr>
       </thead>
       <tbody id="compositionTable">
        <tr class="border-b border-gray-100 hover:bg-gray-50">
         <td class="px-4 py-3 font-medium text-purple-700">ü•© Protein</td>
         <td id="proteinVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="proteinCal" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="proteinOsmol" class="px-4 py-3 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50 bg-blue-50/50">
         <td class="px-4 py-3 font-medium text-blue-700">üç¨ 50% Dextrose</td>
         <td id="dextroseVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="dextroseCal" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="dextroseOsmol" class="px-4 py-3 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
         <td class="px-4 py-3 font-medium text-amber-700">üßà Fat 20%</td>
         <td id="fatVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="fatCal" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
         <td class="px-4 py-3 font-medium text-red-700">üßÇ Electrolytes</td>
         <td id="electrolytesVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
         <td id="electrolytesOsmol" class="px-4 py-3 text-right font-mono">0</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
         <td class="px-4 py-3 font-medium text-green-700">üíä Vitamins &amp; Trace</td>
         <td id="vitaminTraceVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50">
         <td class="px-4 py-3 font-medium text-indigo-700">üß™ Additives</td>
         <td id="additivesVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
        </tr>
        <tr class="border-b border-gray-100 hover:bg-gray-50 bg-green-50/50">
         <td class="px-4 py-3 font-medium text-green-700">üíß Sterile Water</td>
         <td id="waterVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
        </tr>
        <tr class="bg-gray-100 font-bold">
         <td class="px-4 py-3 text-gray-800">‡∏£‡∏ß‡∏° (PN bag)</td>
         <td id="totalPNVol" class="px-4 py-3 text-right font-mono text-blue-700">0.0</td>
         <td id="totalPNCal" class="px-4 py-3 text-right font-mono text-green-700">0.0</td>
         <td id="totalOsmol" class="px-4 py-3 text-right font-mono text-purple-700">0</td>
        </tr>
        <tr class="bg-amber-50">
         <td class="px-4 py-3 font-medium text-amber-700">+ Fat Volume</td>
         <td id="totalFatVol" class="px-4 py-3 text-right font-mono">0.0</td>
         <td id="totalFatCal" class="px-4 py-3 text-right font-mono">0.0</td>
         <td class="px-4 py-3 text-right text-gray-400">-</td>
        </tr>
        <tr class="bg-gradient-to-r from-blue-100 to-green-100 font-bold text-lg">
         <td class="px-4 py-4 text-gray-800 rounded-bl-xl">ÔøΩÔøΩ Total TPN</td>
         <td id="grandTotalVol" class="px-4 py-4 text-right font-mono text-blue-700">0.0</td>
         <td id="grandTotalCal" class="px-4 py-4 text-right font-mono text-green-700">0.0</td>
         <td class="px-4 py-4 text-right font-mono text-purple-700 rounded-br-xl">-</td>
        </tr>
       </tbody>
      </table>
     </div><!-- Calorie & Osmol Summary -->
     <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="p-4 bg-green-50 rounded-xl border border-green-200">
       <div class="text-sm text-green-600 mb-1">
        Total Calories
       </div>
       <div class="flex items-baseline gap-2"><span id="totalCalDisplay" class="text-2xl font-bold text-green-700">0.0</span> <span class="text-green-600">kcal/day</span>
       </div>
      </div>
      <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
       <div class="text-sm text-blue-600 mb-1">
        Calories per kg
       </div>
       <div class="flex items-baseline gap-2"><span id="calPerKg" class="text-2xl font-bold text-blue-700">0.0</span> <span class="text-blue-600">kcal/kg/day</span>
       </div>
      </div>
      <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
       <div class="text-sm text-purple-600 mb-1">
        Final Osmolarity
       </div>
       <div class="flex items-baseline gap-2"><span id="finalOsmol" class="text-2xl font-bold text-purple-700">0</span> <span class="text-purple-600">mOsmol/L</span>
       </div>
      </div>
     </div><!-- Osmolarity Warning -->
     <div id="osmolWarning" class="hidden mt-4 p-4 warning-box rounded-xl">
      <div class="flex items-center gap-2 text-amber-800"><span class="text-xl">‚ö†Ô∏è</span> <span class="font-medium">Osmolarity ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Peripheral Line (&gt; 900 mOsmol/L) ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Central Line</span>
      </div>
     </div>
    </section><!-- Fat Administration -->
    <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
     <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíâ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat</h2>
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><!-- Flush Line -->
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≤‡∏£‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</label>
       <div class="space-y-2"><label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"> <input type="radio" name="flush" value="none" checked onchange="calculateFatAdmin()"> <span class="text-sm">‡πÑ‡∏°‡πà‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span> </label>
        <div class="flex items-center gap-2"><input type="radio" name="flush" value="custom" onchange="calculateFatAdmin()"> <span class="text-sm">+</span> <input type="number" id="flushVolume" min="0" step="1" placeholder="0" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm" inputmode="decimal" oninput="calculateFatAdmin()"> <span class="text-sm text-gray-600">ml ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span>
        </div>
       </div>
      </div><!-- IV Drip Duration -->
      <div><label class="block text-sm font-medium text-gray-700 mb-2">IV drip in</label>
       <div class="space-y-2"><label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"> <input type="radio" name="dripDuration" value="12" checked onchange="calculateFatAdmin()"> <span class="text-sm">12 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span> </label> <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"> <input type="radio" name="dripDuration" value="24" onchange="calculateFatAdmin()"> <span class="text-sm">24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span> </label>
       </div>
      </div><!-- Preparation Split -->
      <div><label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</label>
       <div class="space-y-2"><label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"> <input type="radio" name="prepSplit" value="none" checked onchange="calculateFatAdmin()"> <span class="text-sm">‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á</span> </label> <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"> <input type="radio" name="prepSplit" value="split" onchange="calculateFatAdmin()"> <span class="text-sm">ÔøΩÔøΩ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span> </label>
       </div>
      </div><!-- Fat Rate Result -->
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Fat Rate</label>
       <div id="fatRateContainer" class="p-3 bg-blue-50 rounded-xl border border-blue-200">
        <div class="text-2xl font-bold text-blue-700" id="fatRateValue">
         0.0
        </div>
        <div class="text-xs text-blue-600">
         g/kg/hr
        </div>
       </div>
      </div>
     </div><!-- Fat Rate Warning -->
     <div id="fatRateWarning" class="hidden p-3 warning-box rounded-xl text-sm"><span class="font-medium">‚ö†Ô∏è Fat Rate ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!</span> ‡∏Ñ‡∏ß‡∏£ ‚â§ 0.11 g/kg/hr ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
     </div><!-- Preparation Summary -->
     <div id="prepSummary" class="mt-4 p-4 success-box rounded-xl">
      <h4 class="font-semibold text-green-800 mb-2">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£ÔøΩÔøΩ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat</h4>
      <div id="prepDetails" class="text-green-700"></div>
     </div>
    </section><!-- Summary Section -->
    <section class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl card-shadow p-6 text-white animate-fade-in">
     <h2 class="text-lg font-semibold mb-4 flex items-center gap-2"><span class="text-2xl">üìã</span> ‡∏™‡∏£‡∏∏‡∏õ TPN Order</h2>
     <div id="orderSummary" class="space-y-3 text-blue-100">
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ Order</p>
     </div>
    </section><!-- Save Order Button -->
    <div class="flex gap-2 justify-end mb-6"><button onclick="goToHistory()" class="px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-all"> ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö </button> <button id="saveOrderBtn" onclick="saveOrder()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-all flex items-center gap-2"> <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order </button>
    </div>
   </main><!-- History Page -->
   <div id="historyPage" class="page-hidden h-full overflow-auto">
    <header class="gradient-header text-white py-4 px-6 sticky top-0 z-50 shadow-lg no-print">
     <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
        <svg class="w-8 h-8" fill="currentColor" viewbox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z" />
        </svg>
       </div>
       <div>
        <h1 class="text-xl font-bold tracking-tight">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á TPN</h1>
        <p class="text-blue-100 text-sm">Order History</p>
       </div>
      </div><button onclick="goToCalculator()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm"> ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì </button>
     </div>
    </header>
    <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6"><!-- Filter Section -->
     <section class="bg-white rounded-2xl card-shadow p-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">üîç ‡∏ÅÔøΩÔøΩÔøΩ‡∏≠‡∏áÔøΩÔøΩ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end"><!-- Date Filter -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label> <input type="date" id="filterDate" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
       </div><!-- HN Search -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN:</label> <input type="text" id="searchHN" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå HN" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
       </div><!-- Patient Name Search -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ôÔøΩÔøΩ‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label> <input type="text" id="searchName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
       </div><!-- Search Button --> <button onclick="filterHistory()" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all flex items-center gap-2 justify-center"> <span>üîç</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ </button>
      </div>
     </section><!-- Tab Buttons -->
     <section class="bg-white rounded-2xl card-shadow p-4">
      <div class="flex flex-wrap gap-2"><button onclick="filterByTab('today')" class="tab-button active px-6 py-2 border-2 rounded-lg font-medium transition-all"> üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ </button> <button onclick="filterByTab('yesterday')" class="tab-button inactive px-6 py-2 border-2 rounded-lg font-medium transition-all"> üìÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô </button> <button onclick="filterByTab('all')" class="tab-button inactive px-6 py-2 border-2 rounded-lg font-medium transition-all"> üìÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î </button>
      </div>
     </section><!-- Order List -->
     <section id="historyList" class="bg-white rounded-2xl card-shadow p-6">
      <div id="orderListContainer" class="space-y-4">
       <p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order</p>
      </div>
     </section>
    </main><!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
     <p>TPN Calculator for Pediatric Patients</p>
    </footer>
   </div><!-- Order Detail Modal -->
   <div id="detailModal" class="fixed inset-0 bg-black/50 z-[9999] hidden overflow-auto">
    <div class="min-h-screen py-6 px-4 flex items-center justify-center">
     <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto shadow-2xl"><!-- Detail Header -->
      <div class="gradient-header text-white p-6 sticky top-0 z-50 flex items-center justify-between">
       <div>
        <h2 class="text-2xl font-bold">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î TPN Order</h2>
        <p id="detailPatientInfo" class="text-blue-100 text-sm mt-1">-</p>
       </div><button onclick="closeDetail()" class="text-2xl hover:bg-white/20 p-2 rounded-lg transition-all"> ‚úï </button>
      </div><!-- Detail Content -->
      <div id="detailContent" class="p-6 space-y-6"><!-- ‡∏Ç‡πâ‡∏≠‡∏°ÔøΩÔøΩÔøΩ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">üìã ÔøΩÔøΩ‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
         <div class="p-4 bg-gray-50 rounded-xl"><span class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order</span>
          <p id="det-orderDate" class="font-semibold text-gray-800 mt-1">-</p>
         </div>
         <div class="p-4 bg-gray-50 rounded-xl"><span class="text-xs text-gray-600">HN</span>
          <p id="det-hn" class="font-semibold text-gray-800 mt-1">-</p>
         </div>
         <div class="p-4 bg-gray-50 rounded-xl"><span class="text-xs text-gray-600">ÔøΩÔøΩÔøΩ‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
          <p id="det-patientName" class="font-semibold text-gray-800 mt-1">-</p>
         </div>
         <div class="p-4 bg-gray-50 rounded-xl"><span class="text-xs text-gray-600">Ward</span>
          <p id="det-ward" class="font-semibold text-gray-800 mt-1">-</p>
         </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div class="p-4 bg-blue-50 rounded-xl border border-blue-200"><span class="text-xs text-blue-600">Route</span>
          <p id="det-route" class="font-semibold text-blue-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-green-50 rounded-xl border border-green-200"><span class="text-xs text-green-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (BW)</span>
          <p id="det-bw" class="font-semibold text-green-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-purple-50 rounded-xl border border-purple-200"><span class="text-xs text-purple-600">PN Volume</span>
          <p id="det-pnVolume" class="font-semibold text-purple-700 mt-1">-</p>
         </div>
        </div>
       </section><!-- Macronutrient -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">ü•ó Macronutrient</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
         <div class="p-4 bg-purple-50 rounded-xl border border-purple-200"><span class="text-xs text-purple-600">Protein</span>
          <p id="det-protein" class="font-semibold text-purple-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-amber-50 rounded-xl border border-amber-200"><span class="text-xs text-amber-600">Net Fat</span>
          <p id="det-netFat" class="font-semibold text-amber-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-blue-50 rounded-xl border border-blue-200"><span class="text-xs text-blue-600">Dextrose %</span>
          <p id="det-dextrose" class="font-semibold text-blue-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-red-50 rounded-xl border border-red-200"><span class="text-xs text-red-600">GIR</span>
          <p id="det-gir" class="font-semibold text-red-700 mt-1">-</p>
         </div>
        </div>
       </section><!-- Calories -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">üî• Calories</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div class="p-4 bg-green-50 rounded-xl border border-green-200"><span class="text-xs text-green-600">Total Calories</span>
          <p id="det-totalCalories" class="text-2xl font-bold text-green-700 mt-1">-</p><span class="text-xs text-green-600">kcal/day</span>
         </div>
         <div class="p-4 bg-green-50 rounded-xl border border-green-200"><span class="text-xs text-green-600">Calories per kg</span>
          <p id="det-calPerKg" class="text-2xl font-bold text-green-700 mt-1">-</p><span class="text-xs text-green-600">kcal/kg/day</span>
         </div>
        </div>
       </section><!-- Rate & Volume -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">üíß Rate &amp; Volume</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
         <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200"><span class="text-xs text-cyan-600">Rate TPN</span>
          <p id="det-rateTPN" class="font-semibold text-cyan-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200"><span class="text-xs text-indigo-600">Fat Rate</span>
          <p id="det-fatRate" class="font-semibold text-indigo-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-pink-50 rounded-xl border border-pink-200"><span class="text-xs text-pink-600">Vitalipid Volume</span>
          <p id="det-vitalipid" class="font-semibold text-pink-700 mt-1">-</p>
         </div>
        </div>
       </section><!-- Macronutrient -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">ü•ó Macronutrient</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
         <div class="p-4 bg-purple-50 rounded-xl border border-purple-200"><span class="text-xs text-purple-600">Protein</span>
          <p id="det-protein" class="font-semibold text-purple-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-amber-50 rounded-xl border border-amber-200"><span class="text-xs text-amber-600">Net Fat</span>
          <p id="det-netFat" class="font-semibold text-amber-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-blue-50 rounded-xl border border-blue-200"><span class="text-xs text-blue-600">Dextrose %</span>
          <p id="det-dextrose" class="font-semibold text-blue-700 mt-1">-</p>
         </div>
         <div class="p-4 bg-red-50 rounded-xl border border-red-200"><span class="text-xs text-red-600">GIR</span>
          <p id="det-gir" class="font-semibold text-red-700 mt-1">-</p>
         </div>
        </div>
       </section><!-- Calories -->
       <section class="space-y-4">
        <h3 class="section-title text-lg font-semibold text-gray-800">üî• Calories &amp; Rate</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
         <div class="p-4 bg-green-50 rounded-xl border border-green-200"><span class="text-xs text-green-600">Total Calories</span>
          <p id="det-totalCalories" class="text-2xl font-bold text-green-700 mt-1">-</p><span class="text-xs text-green-600">kcal/day</span>
         </div>
         <div class="p-4 bg-green-50 rounded-xl border border-green-200"><span class="text-xs text-green-600">Calories per kg</span>
          <p id="det-calPerKg" class="text-2xl font-bold text-green-700 mt-1">-</p><span class="text-xs text-green-600">kcal/kg/day</span>
         </div>
         <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200"><span class="text-xs text-cyan-600">Rate TPN</span>
          <p id="det-rateTPN" class="font-semibold text-cyan-700 mt-1">-</p>
         </div>
        </div>
       </section>
       <div class="flex gap-2 justify-end pt-4 border-t border-gray-200"><button onclick="printDetail()" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all"> üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå </button> <button onclick="closeDetail()" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-semibold rounded-xl hover:bg-gray-400 transition-all"> ‡∏õ‡∏¥‡∏î </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="text-center py-6 text-gray-500 text-sm no-print">
    <p>TPN Calculator for Pediatric Patients</p>
    <p class="mt-1">‡πÇ‡∏£‡∏á‡∏û‡∏¢ÔøΩÔøΩ‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå | ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
   </footer>
  </div>
  <script>
    // Initialize Data SDK
    let allOrders = [];
    let currentTab = 'today';

    const dataHandler = {
      onDataChanged(data) {
        allOrders = data;
        filterHistory();
      }
    };

    async function initDataSDK() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initDataSDK();
    });

    // Navigation
    function goToHistory() {
      document.getElementById('mainContent').classList.add('page-hidden');
      document.getElementById('historyPage').classList.remove('page-hidden');
      filterHistory();
    }

    function goToCalculator() {
      document.getElementById('historyPage').classList.add('page-hidden');
      document.getElementById('mainContent').classList.remove('page-hidden');
    }

    // Tab filtering
    function filterByTab(tab) {
      currentTab = tab;
      
      // Update button styles
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('inactive');
      });
      event.target.classList.add('active');
      event.target.classList.remove('inactive');
      
      filterHistory();
    }

    // Filter history
    function filterHistory() {
      const filterDate = document.getElementById('filterDate').value;
      const searchHN = document.getElementById('searchHN').value.toLowerCase();
      const searchName = document.getElementById('searchName').value.toLowerCase();

      let filtered = [...allOrders];

      // Tab filter
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (currentTab === 'today') {
        filtered = filtered.filter(order => {
          const orderDate = new Date(order.order_date);
          return orderDate.toDateString() === today.toDateString();
        });
      } else if (currentTab === 'yesterday') {
        filtered = filtered.filter(order => {
          const orderDate = new Date(order.order_date);
          return orderDate.toDateString() === yesterday.toDateString();
        });
      }

      // Date filter
      if (filterDate) {
        filtered = filtered.filter(order => order.order_date === filterDate);
      }

      // HN search
      if (searchHN) {
        filtered = filtered.filter(order => order.hn.toLowerCase().includes(searchHN));
      }

      // Name search
      if (searchName) {
        filtered = filtered.filter(order => order.patient_name.toLowerCase().includes(searchName));
      }

      // Sort by date (newest first)
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Display
      displayOrderList(filtered);
    }

    function displayOrderList(orders) {
      const container = document.getElementById('orderListContainer');
      
      if (orders.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>';
        return;
      }

      container.innerHTML = orders.map((order, index) => `
        <div onclick="openDetail(${index})" class="p-4 border border-gray-200 rounded-xl hover:shadow-lg transition-all cursor-pointer hover:border-blue-400">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-3">
            <div>
              <span class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
              <p class="font-semibold text-gray-800">${new Date(order.order_date).toLocaleDateString('th-TH')}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">HN</span>
              <p class="font-semibold text-gray-800">${order.hn || '-'}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤ÔøΩÔøΩÔøΩ‡∏™‡∏Å‡∏∏‡∏•</span>
              <p class="font-semibold text-gray-800">${order.patient_name || '-'}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</span>
              <p class="font-semibold text-gray-800">${order.bw} kg</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-gray-600">ÔøΩÔøΩ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
              <p class="text-sm text-blue-600 font-medium">‚Üí ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <div class="bg-purple-50 p-2 rounded">
              <span class="text-xs text-purple-600">Protein</span>
              <p class="font-semibold text-purple-700">${order.protein_target} g/kg</p>
            </div>
            <div class="bg-amber-50 p-2 rounded">
              <span class="text-xs text-amber-600">Fat</span>
              <p class="font-semibold text-amber-700">${order.net_fat.toFixed(1)} g/kg</p>
            </div>
            <div class="bg-blue-50 p-2 rounded">
              <span class="text-xs text-blue-600">GIR</span>
              <p class="font-semibold text-blue-700">${order.gir.toFixed(2)} mg/kg/min</p>
            </div>
            <div class="bg-green-50 p-2 rounded">
              <span class="text-xs text-green-600">Calories</span>
              <p class="font-semibold text-green-700">${order.total_calories.toFixed(1)} kcal</p>
            </div>
          </div>
        </div>
      `).join('');

      // ‡πÄ‡∏Å‡πá‡∏ö orders ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö detail view
      window.currentOrderList = orders;
    }

    // Open Detail Modal
    function openDetail(index) {
      if (!window.currentOrderList || !window.currentOrderList[index]) return;
      
      const order = window.currentOrderList[index];
      
      // Helper for product names
      const productNames = {
        'aminoven': '10% Aminoven¬Æ Infant',
        'amiparen': '10% AmiparenÔøΩÔøΩ',
        'aminoplasmal': '15% Aminoplasmal¬Æ',
        'smof': '20% SMOF Lipid',
        'intralipid': '20% Intralipid'
      };

      // Update header
      document.getElementById('detailPatientInfo').textContent = `HN: ${order.hn} | ${order.patient_name}`;
      
      // Basic Info
      document.getElementById('det-orderDate').textContent = new Date(order.order_date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('det-hn').textContent = order.hn || '-';
      document.getElementById('det-patientName').textContent = order.patient_name || '-';
      document.getElementById('det-ward').textContent = order.ward || '-';
      document.getElementById('det-route').textContent = order.route === 'central' ? 'Central Line' : 'Peripheral Line';
      document.getElementById('det-bw').textContent = `${order.bw} kg`;
      document.getElementById('det-totalVolume').textContent = `${roundToPlace(order.total_volume, 1)} ml`;
      
      // PN Bag Composition
      document.getElementById('det-proteinProduct').textContent = productNames[order.protein_product] || order.protein_product;
      document.getElementById('det-proteinVol').textContent = roundToPlace(order.protein_volume, 1);
      document.getElementById('det-proteinCal').textContent = roundToPlace(order.protein_calories, 1);
      const proteinOsmol = order.pn_volume > 0 ? roundToPlace((order.protein_volume * 5.5 * 1000) / order.pn_volume, 0) : 0;
      document.getElementById('det-proteinOsmol').textContent = proteinOsmol;
      
      document.getElementById('det-dextroseVol').textContent = roundToPlace(order.dextrose_volume, 1);
      document.getElementById('det-dextroseCal').textContent = roundToPlace(order.dextrose_calories, 1);
      const dextroseOsmol = order.pn_volume > 0 ? roundToPlace(((order.dextrose_percent * order.pn_volume) / 100 * 5 * 1000) / order.pn_volume, 0) : 0;
      document.getElementById('det-dextroseOsmol').textContent = dextroseOsmol;
      
      document.getElementById('det-electrolytesVol').textContent = roundToPlace(order.electrolytes_volume, 1);
      const electrolytesOsmol = order.pn_volume > 0 ? roundToPlace(order.total_osmol * 0.3, 0) : 0;
      document.getElementById('det-electrolytesOsmol').textContent = electrolytesOsmol;
      
      const vitaminTraceVol = roundToPlace((order.soluvit_volume || 0) + (order.peditrace_volume || 0), 1);
      document.getElementById('det-vitaminTraceVol').textContent = vitaminTraceVol;
      
      const waterVol = roundToPlace(Math.max(0, order.pn_volume - order.protein_volume - order.dextrose_volume - order.electrolytes_volume - (order.soluvit_volume || 0) - (order.peditrace_volume || 0)), 1);
      document.getElementById('det-waterVol').textContent = waterVol;
      
      document.getElementById('det-totalPNVol').textContent = roundToPlace(order.pn_volume, 1);
      document.getElementById('det-totalPNCal').textContent = roundToPlace(order.protein_calories + order.dextrose_calories, 1);
      document.getElementById('det-totalPNOsmol').textContent = roundToPlace(order.total_osmol, 0);
      
      // Fat Emulsion
      document.getElementById('det-fatProduct').textContent = productNames[order.fat_product] || order.fat_product;
      document.getElementById('det-fatVolDetail').textContent = roundToPlace(order.fat_volume, 1);
      document.getElementById('det-fatCalDetail').textContent = roundToPlace(order.fat_calories, 1);
      
      document.getElementById('det-vitalipidVol').textContent = roundToPlace(order.vitalipid_volume, 1);
      
      document.getElementById('det-totalFatVol').textContent = roundToPlace(order.fat_volume + order.vitalipid_volume, 1);
      document.getElementById('det-totalFatCal').textContent = roundToPlace(order.fat_calories, 1);
      
      // Macronutrient Summary
      document.getElementById('det-protein').textContent = `${order.protein_target} g/kg/day`;
      document.getElementById('det-netFat').textContent = `${roundToPlace(order.net_fat, 1)} g/kg/day`;
      document.getElementById('det-dextrose').textContent = `${order.dextrose_percent}%`;
      document.getElementById('det-gir').textContent = `${roundToPlace(order.gir, 2)} mg/kg/min`;
      
      // Calories & Rate
      document.getElementById('det-totalCalories').textContent = roundToPlace(order.total_calories, 1);
      document.getElementById('det-calPerKg').textContent = roundToPlace(order.cal_per_kg, 1);
      document.getElementById('det-rateTPN').textContent = `${roundToPlace(order.rate_tpn, 1)} ml/hr`;
      document.getElementById('det-fatRate').textContent = `${roundToPlace(order.fat_rate, 4)} g/kg/hr`;
      
      // Show modal
      document.getElementById('detailModal').classList.remove('hidden');
    }

    // Close Detail Modal
    function closeDetail() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    // Print Detail
    function printDetail() {
      window.print();
    }

    // Close modal when clicking outside
    document.getElementById('detailModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDetail();
      }
    });

    // Save Order
    async function saveOrder() {
      const hn = document.getElementById('hn').value;
      const patientName = document.getElementById('patientName').value;
      
      if (!hn || !patientName) {
        showSaveMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å HN ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveOrderBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'ÔøΩÔøΩÔøΩ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      // Calculate protein volume
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked').value;
      const totalProteinGrams = bw * proteinTarget;
      let proteinVolume = 0;
      if (proteinProduct === 'aminoplasmal') {
        proteinVolume = totalProteinGrams / 0.15;
      } else {
        proteinVolume = totalProteinGrams * 10;
      }

      // Calculate dextrose
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      const pnVolume = parseFloat(document.getElementById('pnVolume').value) || 0;
      const dextroseVolume = roundToPlace((dextrosePercent * pnVolume * 2) / 100, 1);
      const dextroseGrams = roundToPlace((dextrosePercent * pnVolume) / 100, 1);

      // Calories
      const proteinCalories = totalProteinGrams * 4;
      const dextroseCalories = dextroseGrams * 3.4;
      const netFat = parseFloat(document.getElementById('netFat').value) || 0;
      const fatGrams = bw * netFat;
      const fatVolume = parseFloat(document.getElementById('fatVolume').value) || 0;
      const fatCalories = fatGrams * 10;
      const vitalipidVolume = parseFloat(document.getElementById('vitalipid').value) || 0;

      const orderData = {
        order_date: document.getElementById('orderDate').value,
        hn: hn,
        patient_name: patientName,
        ward: document.getElementById('ward').value,
        route: document.querySelector('input[name="route"]:checked').value,
        bw: bw,
        pn_volume: pnVolume,
        rate_tpn: parseFloat(document.getElementById('rateTPN').value) || 0,
        protein_target: proteinTarget,
        net_fat: netFat,
        dextrose_percent: dextrosePercent,
        gir: parseFloat(document.getElementById('girValue').textContent) || 0,
        total_calories: parseFloat(document.getElementById('totalCalDisplay').textContent) || 0,
        cal_per_kg: parseFloat(document.getElementById('calPerKg').textContent) || 0,
        fat_rate: parseFloat(document.getElementById('fatRateValue').textContent) || 0,
        timestamp: new Date().toISOString(),
        protein_volume: roundToPlace(proteinVolume, 1),
        dextrose_volume: dextroseVolume,
        fat_volume: roundToPlace(fatVolume, 1),
        vitalipid_volume: roundToPlace(vitalipidVolume, 1),
        total_volume: parseFloat(document.getElementById('totalVolume').value) || 0,
        protein_calories: roundToPlace(proteinCalories, 1),
        dextrose_calories: roundToPlace(dextroseCalories, 1),
        fat_calories: roundToPlace(fatCalories, 1),
        total_osmol: parseFloat(document.getElementById('finalOsmol').textContent) || 0,
        protein_product: proteinProduct,
        fat_product: document.querySelector('input[name="fatProduct"]:checked').value,
        electrolytes_volume: roundToPlace(
          (parseFloat(document.getElementById('phosvol').textContent) || 0) +
          (parseFloat(document.getElementById('navol').textContent) || 0) +
          (parseFloat(document.getElementById('kvol').textContent) || 0) +
          (parseFloat(document.getElementById('mgvol').textContent) || 0) +
          (parseFloat(document.getElementById('cavol').textContent) || 0), 1),
        soluvit_volume: parseFloat(document.getElementById('soluvit').value) || 0,
        peditrace_volume: parseFloat(document.getElementById('peditrace').value) || 0,
        phosphorus: parseFloat(document.getElementById('phosphorus').value) || 0,
        sodium: parseFloat(document.getElementById('sodium').value) || 0,
        potassium: parseFloat(document.getElementById('potassium').value) || 0,
        magnesium: parseFloat(document.getElementById('magnesium').value) || 0,
        calcium: parseFloat(document.getElementById('calcium').value) || 0
      };

      try {
        const result = await window.dataSdk.create(orderData);
        
        if (result.isOk) {
          showSaveMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          setTimeout(() => {
            resetForm();
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
            goToHistory();
          }, 1500);
        } else {
          showSaveMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), 'error');
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalText;
        }
      } catch (err) {
        console.error('Save error:', err);
        showSaveMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    }

    function showSaveMessage(message, type) {
      let existingMsg = document.getElementById('saveMessage');
      if (existingMsg) existingMsg.remove();

      const msgDiv = document.createElement('div');
      msgDiv.id = 'saveMessage';
      msgDiv.className = type === 'success' 
        ? 'fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in'
        : 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);

      if (type === 'success') {
        setTimeout(() => msgDiv.remove(), 3000);
      } else {
        setTimeout(() => msgDiv.remove(), 5000);
      }
    }

    // Default configuration
    const defaultConfig = {
      app_title: 'TPN Calculator - Pediatric',
      hospital_name: '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå',
      primary_color: '#1e3a5f',
      secondary_color: '#3b82f6',
      accent_color: '#10b981',
      text_color: '#1f2937',
      background_color: '#f9fafb'
    };

    let config = { ...defaultConfig };

    // Initialize SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => cfg.primary_color || defaultConfig.primary_color,
              set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => cfg.secondary_color || defaultConfig.secondary_color,
              set: (v) => { cfg.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }
            },
            {
              get: () => cfg.accent_color || defaultConfig.accent_color,
              set: (v) => { cfg.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['app_title', cfg.app_title || defaultConfig.app_title],
          ['hospital_name', cfg.hospital_name || defaultConfig.hospital_name]
        ])
      });
    }

    function applyConfig() {
      const appTitle = document.getElementById('appTitle');
      const hospitalName = document.getElementById('hospitalName');
      
      if (appTitle) appTitle.textContent = config.app_title || defaultConfig.app_title;
      if (hospitalName) hospitalName.textContent = config.hospital_name || defaultConfig.hospital_name;
    }

    // Set today's date as default
    document.getElementById('orderDate').valueAsDate = new Date();

    // Helper function for rounding
    function roundToPlace(num, places) {
      const factor = Math.pow(10, places);
      return Math.round(num * factor) / factor;
    }

    // Main calculation function
    function calculateAll() {
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const totalVolume = parseFloat(document.getElementById('totalVolume').value) || 0;
      const fatTarget = parseFloat(document.getElementById('fatTarget').value) || 0;
      const deductVitalipid = document.getElementById('deductVitalipid').checked;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      
      // Calculate Net Fat
      let netFat = fatTarget;
      if (deductVitalipid) {
        netFat = Math.max(0, fatTarget - 0.4);
      }
      document.getElementById('netFat').value = roundToPlace(netFat, 1);
      document.getElementById('fatDisplay').value = roundToPlace(netFat, 1);
      
      // Calculate Fat Volume
      const calculatedFatVol = bw * netFat * 5;
      const fatVolInput = document.getElementById('fatVolume');
      if (document.activeElement !== fatVolInput) {
        fatVolInput.value = roundToPlace(calculatedFatVol, 1);
      }
      const fatVolume = parseFloat(fatVolInput.value) || 0;
      
      // Calculate Vitalipid
      const calculatedVitalipid = bw * 4;
      const vitalipidInput = document.getElementById('vitalipid');
      if (document.activeElement !== vitalipidInput) {
        vitalipidInput.value = roundToPlace(calculatedVitalipid, 1);
      }
      const vitalipidVolume = parseFloat(vitalipidInput.value) || 0;
      
      // Calculate PN Volume
      const calculatedPNVolume = totalVolume - fatVolume - vitalipidVolume;
      const pnVolumeInput = document.getElementById('pnVolume');
      if (document.activeElement !== pnVolumeInput) {
        pnVolumeInput.value = roundToPlace(Math.max(0, calculatedPNVolume), 1);
      }
      const pnVolume = parseFloat(pnVolumeInput.value) || 0;
      
      // Calculate Rate TPN
      const rateTPN = pnVolume / 24;
      document.getElementById('rateTPN').value = roundToPlace(rateTPN, 1);
      
      // Calculate GIR
      let gir = 0;
      if (bw > 0) {
        gir = (rateTPN * dextrosePercent) / (bw * 6);
      }
      document.getElementById('girValue').textContent = roundToPlace(gir, 2);
      
      // Show GIR warning
      const girWarning = document.getElementById('girWarning');
      if (gir > 12) {
        girWarning.classList.remove('hidden');
      } else {
        girWarning.classList.add('hidden');
      }
      
      // ========== ELECTROLYTES ==========
      const phosphorus = parseFloat(document.getElementById('phosphorus').value) || 0;
      const sodium = parseFloat(document.getElementById('sodium').value) || 0;
      const potassium = parseFloat(document.getElementById('potassium').value) || 0;
      const magnesium = parseFloat(document.getElementById('magnesium').value) || 0;
      const calcium = parseFloat(document.getElementById('calcium').value) || 0;
      
      const phosVolume = roundToPlace(phosphorus * bw, 1);
      const phosNa = roundToPlace(2 * phosVolume, 0);
      document.getElementById('phosvol').textContent = phosVolume;
      document.getElementById('phoNa').textContent = phosNa;
      
      const naRequired = sodium * bw;
      const naFromGlycophos = phosNa;
      const naNeeded = Math.max(0, naRequired - naFromGlycophos);
      const naClVolume = roundToPlace(naNeeded / 0.5, 1);
      document.getElementById('navol').textContent = naClVolume;
      
      const kVolume = roundToPlace((potassium * bw) / 2, 1);
      document.getElementById('kvol').textContent = kVolume;
      
      const mgVolume = roundToPlace((magnesium * bw) / 2, 2);
      document.getElementById('mgvol').textContent = mgVolume;
      
      const caVolume = roundToPlace(calcium * bw, 1);
      document.getElementById('cavol').textContent = caVolume;
      
      const electrolytesVolume = phosVolume + naClVolume + kVolume + mgVolume + caVolume;
      
      // Electrolytes osmolarity
      const naTotalMeq = naFromGlycophos + naNeeded;
      const osmolNa = pnVolume > 0 ? roundToPlace((2 * naTotalMeq * 1000) / pnVolume, 0) : 0;
      const kTotalMeq = potassium * bw;
      const osmolK = pnVolume > 0 ? roundToPlace((2 * kTotalMeq * 1000) / pnVolume, 0) : 0;
      const osmolMg = pnVolume > 0 ? roundToPlace((4 * mgVolume * 1000) / pnVolume, 0) : 0;
      const osmolCa = pnVolume > 0 ? roundToPlace((0.465 * caVolume * 1000) / pnVolume, 0) : 0;
      const electrolytesOsmol = osmolNa + osmolK + osmolMg + osmolCa;
      
      // ========== VITAMINS & TRACE ==========
      const soluvitVolume = roundToPlace(Math.min(bw * 1, 10), 1);
      const peditraceVolume = roundToPlace(Math.min(bw * 1, 15), 1);
      document.getElementById('soluvit').value = soluvitVolume;
      document.getElementById('peditrace').value = peditraceVolume;
      document.getElementById('soluvitWarning').classList.toggle('hidden', !(bw * 1 > 10));
      document.getElementById('peditraceWarning').classList.toggle('hidden', !(bw * 1 > 15));
      
      const vitaminTraceVolume = soluvitVolume + peditraceVolume;
      
      // ========== ADDITIVES ==========
      let additivesVolume = 0;
      
      const isPreterm = document.getElementById('isPreterm').checked;
      const zincOptionsDiv = document.getElementById('zincOptions');
      zincOptionsDiv.classList.toggle('hidden', !isPreterm);
      
      if (isPreterm) {
        const zincSelection = document.querySelector('input[name="zinc"]:checked');
        if (zincSelection && zincSelection.value === 'yes') {
          const calculatedZincVol = 0.3 * bw;
          const zincVolumeInput = document.getElementById('zincVolume');
          if (document.activeElement !== zincVolumeInput) {
            zincVolumeInput.value = roundToPlace(calculatedZincVol, 2);
          }
          additivesVolume += parseFloat(zincVolumeInput.value) || 0;
          document.getElementById('zincVolumeDiv').classList.remove('hidden');
        } else {
          document.getElementById('zincVolumeDiv').classList.add('hidden');
        }
      }
      
      const heparinSelection = document.querySelector('input[name="heparin"]:checked');
      const route = document.querySelector('input[name="route"]:checked').value;
      if (route === 'central' && heparinSelection.value === 'no') {
        document.getElementById('heparinYes').checked = true;
      }
      
      let heparinVolume = 0;
      if (document.querySelector('input[name="heparin"]:checked').value === 'yes') {
        const hepUnits = 1 * pnVolume;
        document.getElementById('heparinUnits').textContent = roundToPlace(hepUnits, 0);
        heparinVolume = roundToPlace(roundToPlace(hepUnits, 0) / 500, 2);
        document.getElementById('heparinVolume').textContent = heparinVolume.toFixed(2);
        document.getElementById('heparinValueDiv').classList.remove('hidden');
      } else {
        document.getElementById('heparinValueDiv').classList.add('hidden');
      }
      
      const additiveOtherName = document.getElementById('additiveOtherName').value || '';
      const additiveOtherVolume = parseFloat(document.getElementById('additiveOtherVolume').value) || 0;
      if (additiveOtherName && additiveOtherVolume > 0) {
        additivesVolume += additiveOtherVolume;
      }
      
      additivesVolume += heparinVolume;
      
      // ========== PROTEIN ==========
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked').value;
      const totalProteinGrams = bw * proteinTarget;
      let proteinVolume = 0;
      if (proteinProduct === 'aminoplasmal') {
        proteinVolume = totalProteinGrams / 0.15;
      } else {
        proteinVolume = totalProteinGrams * 10;
      }
      
      const proteinCalories = totalProteinGrams * 4;
      const proteinOsmol = pnVolume > 0 ? roundToPlace((totalProteinGrams * 10 * 1000) / pnVolume, 0) : 0;
      
      // ========== DEXTROSE ==========
      const dextroseVolume = roundToPlace((dextrosePercent * pnVolume * 2) / 100, 1);
      const dextroseGrams = roundToPlace((dextrosePercent * pnVolume) / 100, 1);
      const dextroseCalories = dextroseGrams * 3.4;
      const dextroseOsmol = pnVolume > 0 ? roundToPlace((dextroseGrams * 5 * 1000) / pnVolume, 0) : 0;
      
      // ========== FAT ==========
      const fatGrams = bw * netFat;
      const fatCalories = fatGrams * 10;
      
      // ========== STERILE WATER ==========
      const allAdditionalVolumes = electrolytesVolume + vitaminTraceVolume + additivesVolume + heparinVolume;
      const waterVolume = roundToPlace(Math.max(0, pnVolume - proteinVolume - dextroseVolume - allAdditionalVolumes), 1);
      
      // ========== UPDATE TABLE ==========
      document.getElementById('proteinVol').textContent = roundToPlace(proteinVolume, 1);
      document.getElementById('proteinCal').textContent = roundToPlace(proteinCalories, 1);
      document.getElementById('proteinOsmol').textContent = roundToPlace(proteinOsmol, 0);
      
      document.getElementById('dextroseVol').textContent = dextroseVolume;
      document.getElementById('dextroseCal').textContent = roundToPlace(dextroseCalories, 1);
      document.getElementById('dextroseOsmol').textContent = roundToPlace(dextroseOsmol, 0);
      
      document.getElementById('fatVol').textContent = roundToPlace(fatVolume, 1);
      document.getElementById('fatCal').textContent = roundToPlace(fatCalories, 1);
      
      document.getElementById('electrolytesVol').textContent = roundToPlace(electrolytesVolume, 1);
      document.getElementById('electrolytesOsmol').textContent = roundToPlace(electrolytesOsmol, 0);
      
      document.getElementById('vitaminTraceVol').textContent = roundToPlace(vitaminTraceVolume, 1);
      document.getElementById('additivesVol').textContent = roundToPlace(additivesVolume, 1);
      document.getElementById('waterVol').textContent = waterVolume;
      
      const totalPNVol = proteinVolume + dextroseVolume + electrolytesVolume + vitaminTraceVolume + additivesVolume + waterVolume;
      const totalPNCal = proteinCalories + dextroseCalories;
      const totalOsmolarity = proteinOsmol + dextroseOsmol + electrolytesOsmol;
      
      document.getElementById('totalPNVol').textContent = roundToPlace(totalPNVol, 1);
      document.getElementById('totalPNCal').textContent = roundToPlace(totalPNCal, 1);
      document.getElementById('totalOsmol').textContent = roundToPlace(totalOsmolarity, 0);
      
      document.getElementById('totalFatVol').textContent = roundToPlace(fatVolume, 1);
      document.getElementById('totalFatCal').textContent = roundToPlace(fatCalories, 1);
      
      const grandTotalVol = totalPNVol + fatVolume;
      const grandTotalCal = totalPNCal + fatCalories;
      
      document.getElementById('grandTotalVol').textContent = roundToPlace(grandTotalVol, 1);
      document.getElementById('grandTotalCal').textContent = roundToPlace(grandTotalCal, 1);
      
      document.getElementById('totalCalDisplay').textContent = roundToPlace(grandTotalCal, 1);
      document.getElementById('calPerKg').textContent = bw > 0 ? roundToPlace(grandTotalCal / bw, 1) : '0.0';
      document.getElementById('finalOsmol').textContent = roundToPlace(totalOsmolarity, 0);
      
      const osmolWarning = document.getElementById('osmolWarning');
      if (route === 'peripheral' && totalOsmolarity > 900) {
        osmolWarning.classList.remove('hidden');
      } else {
        osmolWarning.classList.add('hidden');
      }
      
      calculateFatAdmin();
      updateOrderSummary();
    }

    function calculateFatAdmin() {
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const netFat = parseFloat(document.getElementById('netFat').value) || 0;
      const fatVolume = parseFloat(document.getElementById('fatVolume').value) || 0;
      
      const flushOption = document.querySelector('input[name="flush"]:checked').value;
      const flushVolume = flushOption === 'custom' ? (parseFloat(document.getElementById('flushVolume').value) || 0) : 0;
      
      const dripDuration = parseInt(document.querySelector('input[name="dripDuration"]:checked').value);
      const prepSplit = document.querySelector('input[name="prepSplit"]:checked').value;
      
      const fatGrams = bw * netFat;
      let fatRate = 0;
      if (bw > 0 && dripDuration > 0) {
        fatRate = (fatGrams / bw) / dripDuration;
      }
      
      document.getElementById('fatRateValue').textContent = roundToPlace(fatRate, 4);
      
      const fatRateWarning = document.getElementById('fatRateWarning');
      const fatRateContainer = document.getElementById('fatRateContainer');
      if (fatRate > 0.11) {
        fatRateWarning.classList.remove('hidden');
        fatRateContainer.classList.remove('border-blue-200', 'bg-blue-50');
        fatRateContainer.classList.add('border-red-300', 'bg-red-50');
        document.getElementById('fatRateValue').classList.remove('text-blue-700');
        document.getElementById('fatRateValue').classList.add('text-red-700');
      } else {
        fatRateWarning.classList.add('hidden');
        fatRateContainer.classList.add('border-blue-200', 'bg-blue-50');
        fatRateContainer.classList.remove('border-red-300', 'bg-red-50');
        document.getElementById('fatRateValue').classList.add('text-blue-700');
        document.getElementById('fatRateValue').classList.remove('text-red-700');
      }
      
      const totalFatWithFlush = fatVolume + flushVolume;
      let prepText = '';
      
      if (prepSplit === 'split') {
        const splitVolume = totalFatWithFlush / 2;
        prepText = `
          <p><strong>Fat Volume ‡∏£‡∏ß‡∏°‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢:</strong> ${roundToPlace(totalFatWithFlush, 1)} ml</p>
          <p><strong>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</strong> ${roundToPlace(splitVolume, 1)} ml √ó 2 syringe/‡∏Ç‡∏ß‡∏î</p>
          <p><strong>Rate:</strong> ${roundToPlace(totalFatWithFlush / dripDuration, 1)} ml/hr ‡πÉ‡∏ô ${dripDuration} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        `;
      } else {
        prepText = `
          <p><strong>Fat Volume ‡∏£‡∏ßÔøΩÔøΩ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢:</strong> ${roundToPlace(totalFatWithFlush, 1)} ml</p>
          <p><strong>Rate:</strong> ${roundToPlace(totalFatWithFlush / dripDuration, 1)} ml/hr ‡πÉ‡∏ô ${dripDuration} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
        `;
      }
      
      document.getElementById('prepDetails').innerHTML = prepText;
    }

    function updateOrderSummary() {
      const orderDate = document.getElementById('orderDate').value;
      const hn = document.getElementById('hn').value || '-';
      const patientName = document.getElementById('patientName').value || '-';
      const ward = document.getElementById('ward').value || '-';
      const route = document.querySelector('input[name="route"]:checked').value;
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const pnVolume = parseFloat(document.getElementById('pnVolume').value) || 0;
      const rateTPN = parseFloat(document.getElementById('rateTPN').value) || 0;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const netFat = parseFloat(document.getElementById('netFat').value) || 0;
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      const gir = parseFloat(document.getElementById('girValue').textContent) || 0;
      const vitalipid = parseFloat(document.getElementById('vitalipid').value) || 0;
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked');
      const fatProduct = document.querySelector('input[name="fatProduct"]:checked');
      const totalCal = parseFloat(document.getElementById('totalCalDisplay').textContent) || 0;
      const calPerKg = parseFloat(document.getElementById('calPerKg').textContent) || 0;
      
      const proteinProductName = proteinProduct.parentElement.querySelector('.font-medium').textContent;
      const fatProductName = fatProduct.parentElement.querySelector('.font-medium').textContent;
      
      const formattedDate = orderDate ? new Date(orderDate).toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '-';
      
      const summaryHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <p><span class="text-blue-200">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${formattedDate}</p>
            <p><span class="text-blue-200">üè• HN:</span> ${hn}</p>
            <p><span class="text-blue-200">ÔøΩÔøΩÔøΩ ‡∏ä‡∏∑‡πà‡∏≠:</span> ${patientName}</p>
            <p><span class="text-blue-200">üõèÔ∏è Ward:</span> ${ward}</p>
            <p><span class="text-blue-200">üíâ Route:</span> ${route === 'central' ? 'Central Line' : 'Peripheral Line'}</p>
          </div>
          <div class="space-y-2">
            <p><span class="text-blue-200">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</span> ${bw} kg</p>
            <p><span class="text-blue-200">üíß PN Volume:</span> ${roundToPlace(pnVolume, 1)} ml</p>
            <p><span class="text-blue-200">‚è±Ô∏è Rate:</span> ${roundToPlace(rateTPN, 1)} ml/hr</p>
            <p><span class="text-blue-200">üî• Total Cal:</span> ${roundToPlace(totalCal, 1)} kcal (${roundToPlace(calPerKg, 1)} kcal/kg/day)</p>
          </div>
        </div>
        <hr class="border-blue-400/30 my-3">
        <div class="space-y-2">
          <p><span class="text-blue-200">ü•© Protein:</span> ${proteinTarget} g/kg/day (${proteinProductName})</p>
          <p><span class="text-blue-200">üßà Fat:</span> ${roundToPlace(netFat, 1)} g/kg/day (${fatProductName})</p>
          <p><span class="text-blue-200">üç¨ Dextrose:</span> ${dextrosePercent}%</p>
          <p><span class="text-blue-200">üìä GIR:</span> ${roundToPlace(gir, 2)} mg/kg/min</p>
          <p><span class="text-blue-200">üíä Vitalipid-N Infant:</span> ${roundToPlace(vitalipid, 1)} ml</p>
        </div>
      `;
      
      document.getElementById('orderSummary').innerHTML = summaryHTML;
    }

    function resetForm() {
      document.getElementById('orderDate').valueAsDate = new Date();
      document.getElementById('hn').value = '';
      document.getElementById('patientName').value = '';
      document.getElementById('ward').value = '';
      document.getElementById('bw').value = '';
      document.getElementById('totalVolume').value = '';
      document.getElementById('fatTarget').value = '';
      document.getElementById('proteinTarget').value = '';
      document.getElementById('dextrosePercent').value = '';
      document.getElementById('deductVitalipid').checked = false;
      document.getElementById('flushVolume').value = '';
      document.getElementById('phosphorus').value = '';
      document.getElementById('sodium').value = '';
      document.getElementById('potassium').value = '';
      document.getElementById('magnesium').value = '';
      document.getElementById('calcium').value = '';
      document.getElementById('isPreterm').checked = false;
      document.getElementById('additiveOtherName').value = '';
      document.getElementById('additiveOtherVolume').value = '';
      
      document.querySelector('input[name="route"][value="central"]').checked = true;
      document.querySelector('input[name="proteinProduct"][value="aminoven"]').checked = true;
      document.querySelector('input[name="fatProduct"][value="smof"]').checked = true;
      document.querySelector('input[name="flush"][value="none"]').checked = true;
      document.querySelector('input[name="dripDuration"][value="12"]').checked = true;
      document.querySelector('input[name="prepSplit"][value="none"]').checked = true;
      document.querySelector('input[name="heparin"][value="no"]').checked = true;
      document.querySelector('input[name="zinc"][value="no"]').checked = true;
      
      calculateAll();
    }

    document.querySelectorAll('input[name="route"]').forEach(radio => {
      radio.addEventListener('change', calculateAll);
    });

    calculateAll();
    applyConfig();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c08a911002e1dad',t:'MTc2ODg1MDEyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
