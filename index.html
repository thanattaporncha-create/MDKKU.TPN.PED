<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Calculator - Pediatric | ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Sarabun', 'Inter', sans-serif;
    }
    
    .gradient-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab5 100%);
    }
    
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .input-focus:focus {
      outline: none;
      ring: 2px;
      ring-color: #3b82f6;
      border-color: #3b82f6;
    }
    
    .section-title {
      position: relative;
      padding-left: 12px;
    }
    
    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #3b82f6, #1d4ed8);
      border-radius: 2px;
    }
    
    .result-highlight {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-left: 4px solid #0ea5e9;
    }
    
    .warning-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
    }
    
    .success-box {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-left: 4px solid #10b981;
    }
    
    .table-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    }
    
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    .radio-custom:checked + label {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .checkbox-custom:checked + label {
      background-color: #10b981;
      color: white;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    .print-section {
      display: none;
    }
    
    @media print {
      .no-print {
        display: none !important;
      }
      .print-section {
        display: block !important;
      }
      body {
        font-size: 12pt;
      }
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .tab-button.inactive {
      background-color: white;
      color: #6b7280;
      border-color: #e5e7eb;
    }

    .page-hidden {
      display: none !important;
    }
    html {
  height: auto;
}

body {
  min-height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Dropdown ‡∏Ç‡∏≠‡∏á Ward ‡∏•‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÜ */
#wardDropdown {
  z-index: 9999 !important;
}
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">
    <!-- Header -->
    <header class="gradient-header text-white py-4 px-6 sticky top-0 z-50 shadow-lg no-print">
      <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
            </svg>
          </div>
          <div>
            <h1 id="appTitle" class="text-xl font-bold tracking-tight">TPN Calculator - Pediatric</h1>
            <p id="hospitalName" class="text-blue-100 text-sm">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="historyBtn" onclick="goToHistory()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm">
            üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á TPN
          </button>
          <button onclick="resetForm()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm">
            üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
          </button>
       </div>
      </div>
    </header>

    <!-- Main Content -->
<main id="mainContent" class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
      
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in relative z-30">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order TPN</label>
            <input type="date" id="orderDate" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all bg-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">HN (‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ)</label>
            <input type="text" id="hn" placeholder="‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå HN" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" autofocus>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <input type="text" id="patientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
          </div>
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ward</label>
            <div class="relative">
              <input type="text" id="wardInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" onfocus="showWardList()" oninput="filterWardList()" autocomplete="off">
              <input type="hidden" id="ward"> 
              <div id="wardDropdown" class="hidden absolute left-0 right-0 z-[100] mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl max-h-60 overflow-y-auto">
                <div id="wardOptions" class="py-1"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in relative z-10">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4"> üíâ Route ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ TPN</h2>
        <div class="flex flex-wrap gap-3">
          <input type="radio" name="route" id="central" value="central" class="hidden radio-custom" checked>
          <label for="central" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2">
            <span class="text-xl">ü©∏</span> Central Line
          </label>
          <input type="radio" name="route" id="peripheral" value="peripheral" class="hidden radio-custom">
          <label for="peripheral" class="px-6 py-3 border-2 border-gray-300 rounded-xl cursor-pointer transition-all hover:border-blue-400 font-medium flex items-center gap-2">
            <span class="text-xl">ü§öüèª</span> Peripheral Line
          </label>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìë ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (BW)</label>
            <div class="relative">
              <input type="number" id="bw" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">kg</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Total TPN Volume (‡∏£‡∏ß‡∏° Fat) ‡∏ó‡∏µ‡πà‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î</label>
            <div class="relative">
              <input type="number" id="totalVolume" step="1" min="0" placeholder="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üßà ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat + Vitalipid¬Æ </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fat ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ (Fat requirement) </label>
            <div class="relative">
              <input type="number" id="fatTarget" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-24" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
            <div class="mt-2 flex items-center gap-2 p-2 bg-amber-50 rounded-lg border border-amber-100">
              <input type="checkbox" id="deductVitalipid" class="w-4 h-4 rounded text-blue-600 cursor-pointer" onchange="calculateAll()">
              <label for="deductVitalipid" class="text-[11px] text-gray-700 cursor-pointer font-medium">‡∏´‡∏±‡∏Å Fat ‡∏à‡∏≤‡∏Å Vitalipid¬Æ</label>
              <input type="number" id="vitalipidFatValue" step="0.01" value="0.4" class="w-14 px-1 py-0.5 border border-gray-300 rounded text-xs text-center font-bold text-blue-700" oninput="calculateAll()">
              <span class="text-[10px] text-gray-500">g/kg</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Net Fat ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
            <div class="relative">
              <input type="number" id="netFat" step="0.1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-blue-50 pr-24 font-semibold text-blue-700" readonly inputmode="decimal">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fat Volume</label>
            <div class="relative">
              <input type="number" id="fatVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"> üîã Vitalipid¬Æ </label>
            <div class="relative">
              <input type="number" id="vitalipid" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 font-semibold text-blue-700" inputmode="decimal" oninput="handleVitalipidManualChange()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
            <p id="vitalipidMaxWarning" class="hidden text-[10px] text-red-600 mt-1 font-bold">‚ö†Ô∏è Max = 10 ml</p>
          </div>
        </div>
      </section>

     <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíâ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ Fat</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≤‡∏£‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</label>
            <div class="space-y-2">
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="flush" value="none" checked onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÑ‡∏°‡πà‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span>
              </label>
              <div class="flex items-center gap-2">
                <input type="radio" name="flush" value="custom" onchange="calculateFatAdmin()">
                <span class="text-sm">+</span>
                <input type="number" id="flushVolume" min="0" step="1" placeholder="0" class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-sm" inputmode="decimal" oninput="calculateFatAdmin()">
                <span class="text-sm text-gray-600">ml ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</span>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"> ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ Fat+‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢+ Vitalipid¬Æ</label>
            <div class="relative">
              <input type="number" id="totalFatPlusVitalipid" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-blue-50 font-bold text-blue-700" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml</span>
            </div>
            <p class="text-[10px] text-gray-500 mt-1">(Fat + Flush + Vit)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡πà‡∏á‡πÉ‡∏ô ward NICU, 2‡∏Ñ) </label>
            <div class="space-y-2">
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="prepSplit" value="none" checked onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á</span>
              </label>
              <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="prepSplit" value="split" onchange="calculateFatAdmin()">
                <span class="text-sm">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Drip Rate</label>
            <div class="relative">
              <input type="number" id="manualFatDripRate" step="0.1" placeholder="0.0" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-blue-700" oninput="calculateFatAdmin()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml/hr</span>
            </div>
          </div>
        </div>

        <div id="prepSummary" class="mt-4 p-4 success-box rounded-xl">
          <h4 class="font-semibold text-green-800 mb-2">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat</h4>
          <div id="prepDetails" class="text-green-700 space-y-1 text-sm">
            </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíß PN Volume & Rate</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PN Volume (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)</label>
            <div class="relative">
              <input type="number" id="pnVolume" step="0.1" min="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12 bg-gray-50 font-semibold text-gray-600" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ö‡∏ß‡∏Å‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢</label>
            <div class="relative">
              <input type="number" id="pnFlushVolume" value="30" step="1" min="0" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl input-focus transition-all pr-12 font-bold text-blue-700" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">PN Volume ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</label>
            <div class="relative">
              <input type="number" id="pnPrepVolume" step="0.1" class="w-full px-4 py-2.5 border border-green-300 rounded-xl bg-green-50 pr-12 font-bold text-green-700" readonly>
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Rate TPN (PN √∑ 24)</label>
            <div class="relative">
              <input type="number" id="rateTPN" step="0.01" class="w-full px-4 py-2.5 border border-blue-300 rounded-xl input-focus transition-all pr-16 font-bold text-blue-700" oninput="handleRateManualChange()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml/hr</span>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">Macronutrient</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Protein</label>
            <div class="relative">
              <input type="number" id="proteinTarget" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-24" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fat (Net Fat)</label>
            <div class="relative">
              <input type="number" id="fatDisplay" step="0.1" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl bg-gray-100 pr-24 font-semibold text-gray-600" readonly inputmode="decimal">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">g/kg/day</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">%Dextrose</label>
            <div class="relative">
              <input type="number" id="dextrosePercent" step="0.1" min="0" max="50" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
            </div>
          </div>
        </div>
        <div id="girContainer" class="p-4 rounded-xl result-highlight">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-2xl">üìä</span>
              <div>
                <span class="text-sm text-gray-600">GIR (Glucose Infusion Rate)</span>
                <p class="text-xs text-gray-500 mt-0.5">= (Rate TPN √ó %Dextrose) √∑ (BW √ó 6)</p>
              </div>
            </div>
            <div class="text-right">
              <span id="girValue" class="text-2xl font-bold text-blue-700">0.00</span>
              <span class="text-gray-600 ml-1">mg/kg/min</span>
            </div>
          </div>
          <div id="girWarning" class="hidden mt-2 text-sm text-amber-700 bg-amber-100 px-3 py-2 rounded-lg">
            ‚ö†Ô∏è GIR ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          </div>
        </div>
      </section>

      <!-- Product Selection -->
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üß¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
            <h3 class="font-semibold text-purple-800 mb-3 flex items-center gap-2"><span>ü•©</span> Protein Product</h3>
            <div class="space-y-2">
              <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300">
                <input type="radio" name="proteinProduct" value="aminoven" class="mt-1" checked onchange="calculateAll()">
                <div>
                  <span class="font-medium text-gray-800">10% Aminoven¬Æ Infant</span>
                  <p class="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ 0-1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
              </label>
              <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300">
                <input type="radio" name="proteinProduct" value="amiparen" onchange="calculateAll()">
                <div>
                  <span class="font-medium text-gray-800">10% Amiparen¬Æ</span>
                  <p class="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ > 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>
              </label>
              <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-purple-100 transition-all border border-transparent hover:border-purple-300">
                <input type="radio" name="proteinProduct" value="aminoplasmal" onchange="calculateAll()">
                <div>
                  <span class="font-medium text-gray-800">15% Aminoplasmal¬Æ</span>
                  <p class="text-xs text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏™‡∏π‡∏á (‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)</p>
                </div>
              </label>
            </div>
          </div>
          <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
            <h3 class="font-semibold text-amber-800 mb-3 flex items-center gap-2"><span>üßà</span> Fat Product</h3>
            <div class="space-y-2">
              <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-amber-100 transition-all border border-transparent hover:border-amber-300">
                <input type="radio" name="fatProduct" value="smof" class="mt-1" checked onchange="calculateAll()">
                <div>
                  <span class="font-medium text-gray-800">20% SMOF Lipid</span>
                  <p class="text-xs text-gray-500">Mixed lipid emulsion</p>
                </div>
              </label>
              <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-amber-100 transition-all border border-transparent hover:border-amber-300">
                <input type="radio" name="fatProduct" value="intralipid" onchange="calculateAll()">
                <div>
                  <span class="font-medium text-gray-800">20% Intralipid</span>
                  <p class="text-xs text-gray-500">Soybean oil emulsion</p>
                </div>
              </label>
            </div>
          </div>
        </div>
      </section>

      <!-- Electrolytes Section -->
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">‚öóÔ∏è Electrolytes</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">P (Glycophos¬Æ)</label>
            <p class="text-xs text-gray-600 mb-2">0.5-1 mEq/kg/day</p>
            <div class="relative mb-2">
              <input type="number" id="phosphorus" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
            </div>
            <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
              <p class="text-gray-700"><strong>Vol:</strong> <span id="phosvol">0.0</span> ml</p>
              <p class="text-gray-700"><strong>Na from P:</strong> <span id="phoNa">0</span> mEq</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Na (3% NaCl)</label>
            <p class="text-xs text-gray-600 mb-2">2-4 mEq/kg/day</p>
            <div class="relative mb-2">
              <input type="number" id="sodium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
            </div>
            <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
              <p class="text-gray-700"><strong>Vol:</strong> <span id="navol">0.0</span> ml</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">K (KCl)</label>
            <p class="text-xs text-gray-600 mb-2">2-4 mEq/kg/day</p>
            <div class="relative mb-2">
              <input type="number" id="potassium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
            </div>
            <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
              <p class="text-gray-700"><strong>Vol:</strong> <span id="kvol">0.0</span> ml</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mg (50% MgSO‚ÇÑ)</label>
            <p class="text-xs text-gray-600 mb-2">0.2-0.3 mmol/kg/day</p>
            <div class="relative mb-2">
              <input type="number" id="magnesium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
            </div>
            <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
              <p class="text-gray-700"><strong>Vol:</strong> <span id="mgvol">0.0</span> ml</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ca (10% Ca Gluconate)</label>
            <p class="text-xs text-gray-600 mb-2">4-6 ml/kg/day</p>
            <div class="relative mb-2">
              <input type="number" id="calcium" step="0.1" min="0" placeholder="0.0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
            </div>
            <div class="text-xs bg-blue-50 p-2 rounded-lg border border-blue-200">
              <p class="text-gray-700"><strong>Vol:</strong> <span id="cavol">0.0</span> ml</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Vitamins & Trace Elements Section -->
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üíä Vitamin & Trace Elements</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="p-4 bg-green-50 rounded-xl border border-green-200">
            <h3 class="font-semibold text-green-800 mb-3">üíâ Vitamin</h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Soluvit¬Æ N</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="soluvit" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" readonly inputmode="decimal">
                  <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
                </div>
                <p class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 10 ml)</p>
                <p id="soluvitWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô 10 ml!</p>
              </div>
            </div>
          </div>
          <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200">
            <h3 class="font-semibold text-cyan-800 mb-3">üî¨ Trace Elements</h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Peditrace¬Æ</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="peditrace" step="0.1" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" readonly inputmode="decimal">
                  <span class="text-gray-600 whitespace-nowrap font-medium">ml</span>
                </div>
                <p class="text-xs text-gray-600 mt-1">= 1 √ó BW (Max 15 ml)</p>
                <p id="peditraceWarning" class="hidden text-xs text-red-600 mt-1 font-semibold">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏ô 15 ml!</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Additive Section -->
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üß™ Additive</h2>
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 bg-orange-50 rounded-xl border border-orange-200">
              <h3 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                <input type="checkbox" id="isPreterm" class="w-5 h-5 rounded cursor-pointer" onchange="calculateAll()">
                <label for="isPreterm" class="cursor-pointer">Preterm infant</label>
              </h3>
              <div id="zincOptions" class="space-y-3 hidden">
                <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-orange-100 border border-transparent hover:border-orange-300">
                  <input type="radio" name="zinc" value="yes" class="mt-1" onchange="calculateAll()">
                  <div class="flex-1">
                    <span class="font-medium text-gray-800 block">Add Zinc Sulfate</span>
                    <p class="text-xs text-gray-600">500 mcg/ml = 0.3 ml √ó BW</p>
                  </div>
                </label>
                <div id="zincVolumeDiv" class="hidden ml-8 p-3 bg-white rounded-lg">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Zinc Volume</label>
                  <div class="relative">
                    <input type="number" id="zincVolume" step="0.01" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" inputmode="decimal" oninput="calculateAll()">
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ml</span>
                  </div>
                </div>
                <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-orange-100 border border-transparent hover:border-orange-300">
                  <input type="radio" name="zinc" value="no" class="mt-1" onchange="calculateAll()">
                  <span class="font-medium text-gray-800">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° Zinc</span>
                </label>
              </div>
            </div>
            <div class="p-4 bg-pink-50 rounded-xl border border-pink-200">
              <h3 class="font-semibold text-pink-800 mb-3">üíâ Heparin</h3>
              <div class="space-y-3">
                <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-pink-100 border border-transparent hover:border-pink-300">
                  <input type="radio" name="heparin" value="yes" id="heparinYes" class="mt-1" onchange="calculateAll()">
                  <div class="flex-1">
                    <span class="font-medium text-gray-800 block">‡πÄ‡∏ï‡∏¥‡∏° Heparin</span>
                    <p class="text-xs text-gray-600">1 unit/ml = 1 √ó PN volume</p>
                  </div>
                </label>
                <div id="heparinValueDiv" class="hidden ml-8 p-3 bg-white rounded-lg">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm font-medium text-gray-700">Heparin Units:</span>
                    <span id="heparinUnits" class="text-lg font-bold text-pink-700">0</span>
                    <span class="text-gray-600">units</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-700">Heparin Volume:</span>
                    <span id="heparinVolume" class="text-lg font-bold text-pink-700">0.00</span>
                    <span class="text-gray-600">ml (√∑ 500)</span>
                  </div>
                </div>
                <label class="flex items-start gap-3 p-3 bg-white rounded-lg cursor-pointer hover:bg-pink-100 border border-transparent hover:border-pink-300">
                  <input type="radio" name="heparin" value="no" class="mt-1" checked onchange="calculateAll()">
                  <span class="font-medium text-gray-800">‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏° Heparin</span>
                </label>
              </div>
            </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
            <h3 class="font-semibold text-purple-800 mb-3">‚ûï Add ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</label>
                <input type="text" id="additiveOtherName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Taurine, L-Carnitine" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all" oninput="calculateAll()">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£</label>
                <div class="relative">
                  <input type="number" id="additiveOtherVolume" step="0.1" min="0" placeholder="0" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all pr-12" inputmode="decimal" oninput="calculateAll()">
                  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-medium">ml</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Composition Table -->
      <section class="bg-white rounded-2xl card-shadow p-6 animate-fade-in">
        <h2 class="section-title text-lg font-semibold text-gray-800 mb-4">üìä ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö TPN</h2>
        <div class="overflow-x-auto rounded-xl border border-gray-200">
          <table class="w-full text-sm">
            <thead>
              <tr class="table-header text-white">
                <th class="px-4 py-3 text-left font-semibold rounded-tl-xl">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</th>
                <th class="px-4 py-3 text-right font-semibold">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</th>
                <th class="px-4 py-3 text-right font-semibold">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà (kcal)</th>
                <th class="px-4 py-3 text-right font-semibold rounded-tr-xl">mOsmol/L</th>
              </tr>
            </thead>
            <tbody id="compositionTable">
  <tr class="border-b border-gray-100 font-bold bg-gray-50">
    <td colspan="4" class="px-4 py-2 text-gray-800">üçé Macronutrients</td>
  </tr>
  <tr class="border-b border-gray-100 hover:bg-gray-50">
    <td class="px-4 py-2 pl-8 text-purple-700">ü•© Protein Product</td>
    <td id="proteinVol" class="px-4 py-2 text-right font-mono">0.0</td>
    <td id="proteinCal" class="px-4 py-2 text-right font-mono">0.0</td>
    <td id="proteinOsmol" class="px-4 py-2 text-right font-mono">0</td>
  </tr>
  <tr class="border-b border-gray-100 hover:bg-gray-50">
    <td class="px-4 py-2 pl-8 text-blue-700">üç¨ 50% Dextrose</td>
    <td id="dextroseVol" class="px-4 py-2 text-right font-mono">0.0</td>
    <td id="dextroseCal" class="px-4 py-2 text-right font-mono">0.0</td>
    <td id="dextroseOsmol" class="px-4 py-2 text-right font-mono">0</td>
  </tr>

  <tr class="border-b border-gray-100 font-bold bg-red-50/50">
    <td colspan="4" class="px-4 py-2 text-red-800">üßÇ Electrolytes (ml)</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- Glycophos (P)</td>
    <td id="row-phos-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td id="row-phos-osmol" class="px-4 py-1 text-right font-mono">0</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- 3% NaCl (Na)</td>
    <td id="row-na-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td id="row-na-osmol" class="px-4 py-1 text-right font-mono">0</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- KCl (K)</td>
    <td id="row-k-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td id="row-k-osmol" class="px-4 py-1 text-right font-mono">0</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- 50% MgSO4 (Mg)</td>
    <td id="row-mg-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td id="row-mg-osmol" class="px-4 py-1 text-right font-mono">0</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- 10% Ca Gluconate (Ca)</td>
    <td id="row-ca-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td id="row-ca-osmol" class="px-4 py-1 text-right font-mono">0</td>
  </tr>

  <tr class="border-b border-gray-100 font-bold bg-green-50/50">
    <td colspan="4" class="px-4 py-2 text-green-800">üíä Vitamins & Trace Element (ml)</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- Soluvit N</td>
    <td id="row-soluvit-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- Peditrace</td>
    <td id="row-peditrace-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>

  <tr class="border-b border-gray-100 font-bold bg-orange-50/50">
    <td colspan="4" class="px-4 py-2 text-orange-800">üß™ Additives (ml)</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- Zinc Sulfate</td>
    <td id="row-zinc-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td class="px-4 py-1 pl-8">- Heparin</td>
    <td id="row-heparin-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>
  <tr class="border-b border-gray-100 text-xs">
    <td id="row-other-name" class="px-4 py-1 pl-8">- Other Additive</td>
    <td id="row-other-vol" class="px-4 py-1 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>

  <tr class="border-b border-gray-100 bg-blue-50/50">
    <td class="px-4 py-2 font-medium text-blue-700">üíß Sterile Water</td>
    <td id="waterVol" class="px-4 py-2 text-right font-mono">0.0</td>
    <td class="text-right">-</td>
    <td class="text-right">-</td>
  </tr>
  <tr class="bg-gray-800 text-white font-bold">
    <td class="px-4 py-3">‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ PN Bag</td>
    <td id="totalPNVol" class="px-4 py-3 text-right font-mono text-yellow-400">0.0</td>
    <td id="totalPNCal" class="px-4 py-3 text-right font-mono">0.0</td>
    <td id="totalOsmol" class="px-4 py-3 text-right font-mono">0</td>
  </tr>
</tbody>
          </table>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="p-4 bg-green-50 rounded-xl border border-green-200">
            <div class="text-sm text-green-600 mb-1">Total Calories</div>
            <div class="flex items-baseline gap-2">
              <span id="totalCalDisplay" class="text-2xl font-bold text-green-700">0.0</span>
              <span class="text-green-600">kcal/day</span>
            </div>
          </div>
          <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
            <div class="text-sm text-blue-600 mb-1">Calories per kg</div>
            <div class="flex items-baseline gap-2">
              <span id="calPerKg" class="text-2xl font-bold text-blue-700">0.0</span>
              <span class="text-blue-600">kcal/kg/day</span>
            </div>
          </div>
          <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
            <div class="text-sm text-purple-600 mb-1">Final Osmolarity</div>
            <div class="flex items-baseline gap-2">
              <span id="finalOsmol" class="text-2xl font-bold text-purple-700">0</span>
              <span class="text-purple-600">mOsmol/L</span>
            </div>
          </div>
        </div>
        <div id="osmolWarning" class="hidden mt-4 p-4 warning-box rounded-xl">
          <div class="flex items-center gap-2 text-amber-800">
            <span class="text-xl">‚ö†Ô∏è</span>
            <span class="font-medium">Osmolarity ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Peripheral Line (> 900 mOsmol/L) ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Central Line</span>
          </div>
        </div>
      </section>
  
      <!-- Save Order Button -->
      <div class="flex gap-2 justify-end mb-6">
        <button onclick="goToHistory()" class="px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-all">
          ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        </button>
        <button id="saveOrderBtn" onclick="saveOrder()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-all flex items-center gap-2">
          <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order
        </button>
      </div>
    </main>

    <!-- History Page -->
    <div id="historyPage" class="page-hidden">
      <header class="gradient-header text-white py-4 px-6 sticky top-0 z-50 shadow-lg no-print">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-bold tracking-tight">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á TPN</h1>
              <p class="text-blue-100 text-sm">Order History</p>
            </div>
          </div>
          <button onclick="goToCalculator()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all text-sm font-medium backdrop-blur-sm">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
          </button>
        </div>
      </header>

      <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
        <!-- Filter Section -->
        <section class="bg-white rounded-2xl card-shadow p-6">
          <h2 class="text-lg font-semibold text-gray-800 mb-4">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
              <input type="date" id="filterDate" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN:</label>
              <input type="text" id="searchHN" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå HN" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
              <input type="text" id="searchName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl input-focus transition-all">
            </div>
            <button onclick="filterHistory()" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all flex items-center gap-2 justify-center">
              <span>üîç</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
          </div>
        </section>

        <!-- Tab Buttons -->
        <section class="bg-white rounded-2xl card-shadow p-4">
          <div class="flex flex-wrap gap-2">
           <button onclick="filterByTab('today')" class="tab-button active px-6 py-2 border-2 rounded-lg font-medium transition-all">
  üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
</button>
<button onclick="filterByTab('all')" class="tab-button inactive px-6 py-2 border-2 rounded-lg font-medium transition-all">
  üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
</button>
          </div>
        </section>

        <!-- Order List -->
        <section id="historyList" class="bg-white rounded-2xl card-shadow p-6">
          <div id="orderListContainer" class="space-y-4">
            <p class="text-gray-500 text-center py-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="text-center py-6 text-gray-500 text-sm">
        <p>TPN Calculator for Pediatric Patients</p>
      </footer>
    </div>

    <!-- Order Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 z-[9999] hidden overflow-auto">
      <div class="min-h-screen py-6 px-4 flex items-center justify-center">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto shadow-2xl">
          <div class="gradient-header text-white p-6 sticky top-0 z-50 flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î TPN Order</h2>
              <p id="detailPatientInfo" class="text-blue-100 text-sm mt-1">-</p>
            </div>
            <button onclick="closeDetail()" class="text-2xl hover:bg-white/20 p-2 rounded-lg transition-all">
              ‚úï
            </button>
          </div>
          <div id="detailContent" class="p-6 space-y-6">
            <section class="space-y-4">
              <h3 class="section-title text-lg font-semibold text-gray-800">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 bg-gray-50 rounded-xl">
                  <span class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order</span>
                  <p id="det-orderDate" class="font-semibold text-gray-800 mt-1">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl">
                  <span class="text-xs text-gray-600">HN</span>
                  <p id="det-hn" class="font-semibold text-gray-800 mt-1">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl">
                  <span class="text-xs text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
                  <p id="det-patientName" class="font-semibold text-gray-800 mt-1">-</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl">
                  <span class="text-xs text-gray-600">Ward</span>
                  <p id="det-ward" class="font-semibold text-gray-800 mt-1">-</p>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                  <span class="text-xs text-blue-600">Route</span>
                  <p id="det-route" class="font-semibold text-blue-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                  <span class="text-xs text-green-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (BW)</span>
                  <p id="det-bw" class="font-semibold text-green-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                  <span class="text-xs text-purple-600">PN Volume</span>
                  <p id="det-pnVolume" class="font-semibold text-purple-700 mt-1">-</p>
                </div>
              </div>
            </section>

            <section class="space-y-4">
              <h3 class="section-title text-lg font-semibold text-gray-800">ü•ó Macronutrient</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                  <span class="text-xs text-purple-600">Protein</span>
                  <p id="det-protein" class="font-semibold text-purple-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                  <span class="text-xs text-amber-600">Net Fat</span>
                  <p id="det-netFat" class="font-semibold text-amber-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                  <span class="text-xs text-blue-600">Dextrose %</span>
                  <p id="det-dextrose" class="font-semibold text-blue-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-red-50 rounded-xl border border-red-200">
                  <span class="text-xs text-red-600">GIR</span>
                  <p id="det-gir" class="font-semibold text-red-700 mt-1">-</p>
                </div>
              </div>
            </section>

            <section class="space-y-4">
              <h3 class="section-title text-lg font-semibold text-gray-800">üî• Calories</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                  <span class="text-xs text-green-600">Total Calories</span>
                  <p id="det-totalCalories" class="text-2xl font-bold text-green-700 mt-1">-</p>
                  <span class="text-xs text-green-600">kcal/day</span>
                </div>
                <div class="p-4 bg-green-50 rounded-xl border border-green-200">
                  <span class="text-xs text-green-600">Calories per kg</span>
                  <p id="det-calPerKg" class="text-2xl font-bold text-green-700 mt-1">-</p>
                  <span class="text-xs text-green-600">kcal/kg/day</span>
                </div>
              </div>
            </section>

            <section class="space-y-4">
              <h3 class="section-title text-lg font-semibold text-gray-800">üíß Rate & Volume</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-cyan-50 rounded-xl border border-cyan-200">
                  <span class="text-xs text-cyan-600">Rate TPN</span>
                  <p id="det-rateTPN" class="font-semibold text-cyan-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
                  <span class="text-xs text-indigo-600">Fat Rate</span>
                  <p id="det-fatRate" class="font-semibold text-indigo-700 mt-1">-</p>
                </div>
                <div class="p-4 bg-pink-50 rounded-xl border border-pink-200">
                  <span class="text-xs text-pink-600">Vitalipid Volume</span>
                  <p id="det-vitalipid" class="font-semibold text-pink-700 mt-1">-</p>
                </div>
              </div>
            </section>

            <div class="flex gap-2 justify-end pt-4 border-t border-gray-200">
              <button onclick="printDetail()" class="px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all">
                üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
              </button>
              <button onclick="closeDetail()" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-semibold rounded-xl hover:bg-gray-400 transition-all">
                ‡∏õ‡∏¥‡∏î
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm no-print">
      <p>TPN Calculator for Pediatric Patients</p>
      <p class="mt-1">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå | ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
    </footer>
  </div>

  <script>
    // ========================================
    // TPN Calculator with Google Apps Script
    // ========================================
    
    // üîß Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbydwSjFccNK4WdGhjVW0tikcYMuZJ5pLKLYdROcjGYVY9qvz4hk0-c0OYKFjVmgV-VN/exec';
    
    // Global variables
    let allOrders = [];
    let currentTab = 'today';
    let isVitalipidManual = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏ä‡πà‡∏≠‡∏á Vitalipid ‡πÄ‡∏≠‡∏á
    let isRateManual = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ Rate ‡πÄ‡∏≠‡∏á

    // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
const wardList = [
  "2‡∏á", "3‡∏Å", "3‡∏Ñ", "3‡∏á", "3‡∏â", "4‡∏Å", "4‡∏Ñ", "5‡∏Ç", "6‡∏Å", "6‡∏Ç", 
  "AE1", "AE2", "AE3", "CCU", "CVT-ICU", "HOME PN", "IMC2‡∏á", "IMC3‡∏Ç", "IMC4‡∏Ç", 
  "MICU 1", "MICU 2", "NICU", "PICU", "PICU ‡∏®‡∏™‡∏Å.", "SCTU", "SICU 1", "SICU 2", 
  "‡∏Å‡∏ß.6/1", "‡∏Å‡∏ß.6/2", "‡∏Å‡∏ß.7/1", "‡∏Å‡∏ß.7/2", "‡∏™‡∏ß.1/11", "‡∏™‡∏ß.1/12", "‡∏™‡∏ß.1/13", 
  "‡∏™‡∏ß.1/14", "‡∏™‡∏ß.1/15", "‡∏™‡∏ß.1/8B", "‡∏™‡∏ß.1/8C", "‡∏™‡∏ß.1/9A", "‡∏™‡∏ß.1/9B", "‡∏™‡∏ß.1/9C"
];

function showWardList() {
  const dropdown = document.getElementById('wardDropdown');
  dropdown.classList.remove('hidden');
  renderWardOptions(wardList);
}

function filterWardList() {
  const searchTerm = document.getElementById('wardInput').value.toLowerCase();
  const filtered = wardList.filter(ward => ward.toLowerCase().includes(searchTerm));
  renderWardOptions(filtered);
}

function renderWardOptions(list) {
  const container = document.getElementById('wardOptions');
  if (list.length === 0) {
    container.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }
  
  container.innerHTML = list.map(ward => `
    <div onclick="selectWard('${ward}')" 
      class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-gray-700 text-sm transition-colors border-b border-gray-50 last:border-0">
      ${ward}
    </div>
  `).join('');
}

function selectWard(val) {
  document.getElementById('wardInput').value = val;
  document.getElementById('ward').value = val;
  document.getElementById('wardDropdown').classList.add('hidden');
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ (Summary) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (typeof calculateAll === "function") calculateAll();
}

// ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
document.addEventListener('click', function(e) {
  const wardContainer = document.getElementById('wardInput').parentElement;
  if (!wardContainer.contains(e.target)) {
    document.getElementById('wardDropdown').classList.add('hidden');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô List ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å List)
    const currentInput = document.getElementById('wardInput').value;
    if (!wardList.includes(currentInput)) {
      document.getElementById('wardInput').value = '';
      document.getElementById('ward').value = '';
    }
  }
});

    // ========== API Functions ==========

    async function fetchAllOrders() {
      try {
        console.log('üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        const response = await fetch(`${API_URL}?action=read`);
        const result = await response.json();
        
        if (result.status === 'success') {
          allOrders = result.data || [];
          console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', allOrders.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
          filterHistory();
          return allOrders;
        } else {
          console.error('‚ùå Error:', result.message);
          document.getElementById('orderListContainer').innerHTML = 
            '<p class="text-red-500 text-center py-8">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
          return [];
        }
      } catch (error) {
        console.error('‚ùå Fetch error:', error);
        document.getElementById('orderListContainer').innerHTML = 
          '<p class="text-red-500 text-center py-8">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</p>';
        return [];
      }
    }

 async function saveOrder() {
      const hn = document.getElementById('hn').value;
      const patientName = document.getElementById('patientName').value;
      
      if (!hn || !patientName) {
        showSaveMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å HN ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveOrderBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      const orderData = {
        order_date: document.getElementById('orderDate').value,
        hn: hn,
        patient_name: patientName,
        ward: document.getElementById('ward').value,
        route: document.querySelector('input[name="route"]:checked').value,
        bw: parseFloat(document.getElementById('bw').value) || 0,
        total_volume: parseFloat(document.getElementById('totalVolume').value) || 0,
        pn_volume: parseFloat(document.getElementById('pnVolume').value) || 0,
        rate_tpn: parseFloat(document.getElementById('rateTPN').value) || 0,
        
        protein_target: parseFloat(document.getElementById('proteinTarget').value) || 0,
        protein_product: document.querySelector('input[name="proteinProduct"]:checked').value,
        fat_target: parseFloat(document.getElementById('fatTarget').value) || 0,
        net_fat: parseFloat(document.getElementById('netFat').value) || 0,
        fat_volume: parseFloat(document.getElementById('fatVolume').value) || 0,
        fat_product: document.querySelector('input[name="fatProduct"]:checked').value,
        vitalipid: parseFloat(document.getElementById('vitalipid').value) || 0,
        deduct_vitalipid: document.getElementById('deductVitalipid').checked,
        dextrose_percent: parseFloat(document.getElementById('dextrosePercent').value) || 0,
        gir: parseFloat(document.getElementById('girValue').textContent) || 0,
        
        phosphorus: parseFloat(document.getElementById('phosphorus').value) || 0,
        sodium: parseFloat(document.getElementById('sodium').value) || 0,
        potassium: parseFloat(document.getElementById('potassium').value) || 0,
        magnesium: parseFloat(document.getElementById('magnesium').value) || 0,
        calcium: parseFloat(document.getElementById('calcium').value) || 0,
        
        soluvit: parseFloat(document.getElementById('soluvit').value) || 0,
        peditrace: parseFloat(document.getElementById('peditrace').value) || 0,
        
        is_preterm: document.getElementById('isPreterm').checked,
        zinc_added: document.querySelector('input[name="zinc"]:checked')?.value === 'yes',
        zinc_volume: parseFloat(document.getElementById('zincVolume').value) || 0,
        heparin_added: document.querySelector('input[name="heparin"]:checked')?.value === 'yes',
        additive_other_name: document.getElementById('additiveOtherName').value || '',
        additive_other_volume: parseFloat(document.getElementById('additiveOtherVolume').value) || 0,
        
        protein_volume: parseFloat(document.getElementById('proteinVol').textContent) || 0,
        dextrose_volume: parseFloat(document.getElementById('dextroseVol').textContent) || 0,
        electrolytes_volume: parseFloat(document.getElementById('electrolytesVol').textContent) || 0,
        vitamin_trace_volume: parseFloat(document.getElementById('vitaminTraceVol').textContent) || 0,
        additives_volume: parseFloat(document.getElementById('additivesVol').textContent) || 0,
        water_volume: parseFloat(document.getElementById('waterVol').textContent) || 0,
        
        total_calories: parseFloat(document.getElementById('totalCalDisplay').textContent) || 0,
        cal_per_kg: parseFloat(document.getElementById('calPerKg').textContent) || 0,
        osmolarity: parseFloat(document.getElementById('finalOsmol').textContent) || 0,
        
        flush_option: document.querySelector('input[name="flush"]:checked').value,
        flush_volume: parseFloat(document.getElementById('flushVolume').value) || 0,
        drip_duration: parseInt(document.querySelector('input[name="dripDuration"]:checked').value),
        prep_split: document.querySelector('input[name="prepSplit"]:checked').value,
        fat_rate: parseFloat(document.getElementById('fatRateValue').textContent) || 0,
        
        timestamp: new Date().toISOString()
      };

      try {
        console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
        
        const formData = new URLSearchParams();
        formData.append('action', 'create');
        Object.keys(orderData).forEach(key => {
          formData.append(key, orderData[key]);
        });
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ fetch
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formData.toString()
        });
        
        console.log('üì® Response status:', response.status);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö JSON response ‡∏à‡∏≤‡∏Å server (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Apps Script)');
        }
        
        const result = await response.json();
        console.log('üì¶ Result:', result);
        
        if (result.status === 'success') {
          console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          showSaveMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Order ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          
          setTimeout(() => {
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
            
            resetForm();
            goToHistory();
            fetchAllOrders();
          }, 1500);
        } else {
          throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        }
        
      } catch (error) {
        console.error('‚ùå Save error:', error);
        showSaveMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    }
    function showSaveMessage(message, type) {
      let existingMsg = document.getElementById('saveMessage');
      if (existingMsg) existingMsg.remove();

      const msgDiv = document.createElement('div');
      msgDiv.id = 'saveMessage';
      msgDiv.className = type === 'success' 
        ? 'fixed top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in'
        : 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-fade-in';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);

      setTimeout(() => msgDiv.remove(), type === 'success' ? 3000 : 5000);
    }

    // ========== Navigation ==========

   async function goToHistory() {
    document.getElementById('mainContent').classList.add('page-hidden');
    document.getElementById('historyPage').classList.remove('page-hidden');
    
    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Tab ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 'today'
    currentTab = 'today';
    
    // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° Tab ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡∏ü‡πâ‡∏≤
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(t => {
        if(t.innerText.includes('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')) {
            t.classList.add('active');
            t.classList.remove('inactive');
        } else {
            t.classList.remove('active');
            t.classList.add('inactive');
        }
    });

    // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Server
    await fetchAllOrders(); 
}

    function goToCalculator() {
      document.getElementById('historyPage').classList.add('page-hidden');
      document.getElementById('mainContent').classList.remove('page-hidden');
    }

    // ========== Filter & Display ==========

    function filterByTab(tab) {
    currentTab = tab;
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('inactive');
    });
    event.currentTarget.classList.add('active');
    event.currentTarget.classList.remove('inactive');
    
    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Tab "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏µ‡∏Å‡∏±‡∏ô
    if (tab === 'today') {
        document.getElementById('filterDate').value = ''; 
    }
    
    filterHistory();
}

function filterHistory() {
    const filterDateInput = document.getElementById('filterDate').value; // ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (YYYY-MM-DD)
    const searchHN = document.getElementById('searchHN').value.trim().toLowerCase();
    const searchName = document.getElementById('searchName').value.trim().toLowerCase();

    let filtered = [...allOrders];

    // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Tab (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
    if (currentTab === 'today') {
        const todayStr = new Date().toISOString().split('T')[0];
        filtered = filtered.filter(order => {
            if (!order.order_date) return false;
            const orderDateStr = new Date(order.order_date).toISOString().split('T')[0];
            return orderDateStr === todayStr;
        });
    }

    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á)
    if (filterDateInput) {
        filtered = filtered.filter(order => {
            if (!order.order_date) return false;
            const orderDateStr = new Date(order.order_date).toISOString().split('T')[0];
            return orderDateStr === filterDateInput;
        });
    }

    // 3. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ HN
    if (searchHN) {
        filtered = filtered.filter(order => 
            (order.hn || '').toString().toLowerCase().includes(searchHN)
        );
    }

    // 4. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    if (searchName) {
        filtered = filtered.filter(order => 
            (order.patient_name || '').toLowerCase().includes(searchName)
        );
    }

    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Timestamp)
    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    displayOrderList(filtered);
}

    function displayOrderList(orders) {
      const container = document.getElementById('orderListContainer');
      
      if (orders.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>';
        return;
      }

      container.innerHTML = orders.map((order, index) => `
        <div onclick="openDetail(${index})" class="p-4 border border-gray-200 rounded-xl hover:shadow-lg transition-all cursor-pointer hover:border-blue-400">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-3">
            <div>
              <span class="text-xs text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
              <p class="font-semibold text-gray-800">${order.order_date ? new Date(order.order_date).toLocaleDateString('th-TH') : '-'}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">HN</span>
              <p class="font-semibold text-gray-800">${order.hn || '-'}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
              <p class="font-semibold text-gray-800">${order.patient_name || '-'}</p>
            </div>
            <div>
              <span class="text-xs text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</span>
              <p class="font-semibold text-gray-800">${order.bw || 0} kg</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
              <p class="text-sm text-blue-600 font-medium">‚Üí ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <div class="bg-purple-50 p-2 rounded">
              <span class="text-xs text-purple-600">Protein</span>
              <p class="font-semibold text-purple-700">${order.protein_target || 0} g/kg</p>
            </div>
            <div class="bg-amber-50 p-2 rounded">
              <span class="text-xs text-amber-600">Fat</span>
              <p class="font-semibold text-amber-700">${parseFloat(order.net_fat || 0).toFixed(1)} g/kg</p>
            </div>
            <div class="bg-blue-50 p-2 rounded">
              <span class="text-xs text-blue-600">GIR</span>
              <p class="font-semibold text-blue-700">${parseFloat(order.gir || 0).toFixed(2)} mg/kg/min</p>
            </div>
            <div class="bg-green-50 p-2 rounded">
              <span class="text-xs text-green-600">Calories</span>
              <p class="font-semibold text-green-700">${parseFloat(order.total_calories || 0).toFixed(1)} kcal</p>
            </div>
          </div>
        </div>
      `).join('');

      window.currentOrderList = orders;
    }

    // ========== Detail Modal ==========

    function openDetail(index) {
      if (!window.currentOrderList || !window.currentOrderList[index]) return;
      
      const order = window.currentOrderList[index];
      
      document.getElementById('detailPatientInfo').textContent = `HN: ${order.hn || '-'} | ${order.patient_name || '-'}`;
      
      document.getElementById('det-orderDate').textContent = order.order_date ? new Date(order.order_date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) : '-';
      document.getElementById('det-hn').textContent = order.hn || '-';
      document.getElementById('det-patientName').textContent = order.patient_name || '-';
      document.getElementById('det-ward').textContent = order.ward || '-';
      document.getElementById('det-route').textContent = order.route === 'central' ? 'Central Line' : 'Peripheral Line';
      document.getElementById('det-bw').textContent = `${order.bw || 0} kg`;
      document.getElementById('det-pnVolume').textContent = `${roundToPlace(order.pn_volume || 0, 1)} ml`;
      
      document.getElementById('det-protein').textContent = `${order.protein_target || 0} g/kg/day`;
      document.getElementById('det-netFat').textContent = `${roundToPlace(order.net_fat || 0, 1)} g/kg/day`;
      document.getElementById('det-dextrose').textContent = `${order.dextrose_percent || 0}%`;
      document.getElementById('det-gir').textContent = `${roundToPlace(order.gir || 0, 2)} mg/kg/min`;
      
      document.getElementById('det-totalCalories').textContent = roundToPlace(order.total_calories || 0, 1);
      document.getElementById('det-calPerKg').textContent = roundToPlace(order.cal_per_kg || 0, 1);
      
      document.getElementById('det-rateTPN').textContent = `${roundToPlace(order.rate_tpn || 0, 1)} ml/hr`;
      document.getElementById('det-fatRate').textContent = `${roundToPlace(order.fat_rate || 0, 4)} g/kg/hr`;
      document.getElementById('det-vitalipid').textContent = `${roundToPlace(order.vitalipid || 0, 1)} ml`;
      
      document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeDetail() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    function printDetail() {
      window.print();
    }

    document.getElementById('detailModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDetail();
      }
    });

    // ========== Helper Functions ==========

    function roundToPlace(num, places) {
      const factor = Math.pow(10, places);
      return Math.round((num || 0) * factor) / factor;
    }

    // ========== Calculation Functions ==========

    function calculateAll() {
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const totalVolume = parseFloat(document.getElementById('totalVolume').value) || 0;
      const fatTarget = parseFloat(document.getElementById('fatTarget').value) || 0;
      const deductVitalipid = document.getElementById('deductVitalipid').checked;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      
     // --- [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Vitalipid Volume (4xBW, Max 10) ---
  const vitalipidInput = document.getElementById('vitalipid');
  const vitalipidWarning = document.getElementById('vitalipidMaxWarning');
  const vitalipidFatValue = parseFloat(document.getElementById('vitalipidFatValue').value) || 0;

  if (!isVitalipidManual) {
    let autoVitalipid = bw * 4;
    if (autoVitalipid > 10) {
      autoVitalipid = 10;
      vitalipidWarning.classList.remove('hidden');
    } else {
      vitalipidWarning.classList.add('hidden');
    }
    vitalipidInput.value = roundToPlace(autoVitalipid, 1);
  } else {
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÄ‡∏≠‡∏á ‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏î‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (parseFloat(vitalipidInput.value) > 10) vitalipidWarning.classList.remove('hidden');
    else vitalipidWarning.classList.add('hidden');
  }
  const vitalipidVolume = parseFloat(vitalipidInput.value) || 0;

  // --- [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Net Fat (‡∏´‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÉ‡∏ô Checkbox) ---
  let netFat = fatTarget;
  if (document.getElementById('deductVitalipid').checked) {
    netFat = Math.max(0, fatTarget - vitalipidFatValue);
  }
  document.getElementById('netFat').value = roundToPlace(netFat, 1);
  document.getElementById('fatDisplay').value = roundToPlace(netFat, 1);

  // --- [‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Fat Volume ---
  const fatVolInput = document.getElementById('fatVolume');
  const calculatedFatVol = bw * netFat * 5;
  if (document.activeElement !== fatVolInput) {
    fatVolInput.value = roundToPlace(calculatedFatVol, 1);
  }
  const fatVolume = parseFloat(fatVolInput.value) || 0;
      
      // --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô calculateAll() ---
      const calculatedPNVolume = totalVolume - fatVolume - vitalipidVolume;
      const pnVolumeInput = document.getElementById('pnVolume');
      const pnVolume = Math.max(0, calculatedPNVolume);
      pnVolumeInput.value = roundToPlace(pnVolume, 1);
      
      // [‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà] ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°
      const pnFlush = parseFloat(document.getElementById('pnFlushVolume').value) || 0;
      const pnPrepVolume = pnVolume + pnFlush;
      document.getElementById('pnPrepVolume').value = roundToPlace(pnPrepVolume, 1);

      // Rate TPN ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ PN ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢) ‡∏´‡∏≤‡∏£ 24
      const rateTPN = pnVolume / 24;
      document.getElementById('rateTPN').value = roundToPlace(rateTPN, 1);
      // ------------------------------------------
      
      let gir = 0;
      if (bw > 0) {
        gir = (rateTPN * dextrosePercent) / (bw * 6);
      }
      document.getElementById('girValue').textContent = roundToPlace(gir, 2);
      
      const girWarning = document.getElementById('girWarning');
      if (gir > 12) {
        girWarning.classList.remove('hidden');
      } else {
        girWarning.classList.add('hidden');
      }
      
      const phosphorus = parseFloat(document.getElementById('phosphorus').value) || 0;
      const sodium = parseFloat(document.getElementById('sodium').value) || 0;
      const potassium = parseFloat(document.getElementById('potassium').value) || 0;
      const magnesium = parseFloat(document.getElementById('magnesium').value) || 0;
      const calcium = parseFloat(document.getElementById('calcium').value) || 0;
      
      const phosVolume = roundToPlace(phosphorus * bw, 1);
      const phosNa = roundToPlace(2 * phosVolume, 0);
      document.getElementById('phosvol').textContent = phosVolume;
      document.getElementById('phoNa').textContent = phosNa;
      
      const naRequired = sodium * bw;
      const naFromGlycophos = phosNa;
      const naNeeded = Math.max(0, naRequired - naFromGlycophos);
      const naClVolume = roundToPlace(naNeeded / 0.5, 1);
      document.getElementById('navol').textContent = naClVolume;
      
      const kVolume = roundToPlace((potassium * bw) / 2, 1);
      document.getElementById('kvol').textContent = kVolume;
      
      const mgVolume = roundToPlace((magnesium * bw) / 2, 2);
      document.getElementById('mgvol').textContent = mgVolume;
      
      const caVolume = roundToPlace(calcium * bw, 1);
      document.getElementById('cavol').textContent = caVolume;
      
      const electrolytesVolume = phosVolume + naClVolume + kVolume + mgVolume + caVolume;
      
      const naTotalMeq = naFromGlycophos + naNeeded;
      const osmolNa = pnVolume > 0 ? roundToPlace((2 * naTotalMeq * 1000) / pnVolume, 0) : 0;
      const kTotalMeq = potassium * bw;
      const osmolK = pnVolume > 0 ? roundToPlace((2 * kTotalMeq * 1000) / pnVolume, 0) : 0;
      const osmolMg = pnVolume > 0 ? roundToPlace((4 * mgVolume * 1000) / pnVolume, 0) : 0;
      const osmolCa = pnVolume > 0 ? roundToPlace((0.465 * caVolume * 1000) / pnVolume, 0) : 0;
      const electrolytesOsmol = osmolNa + osmolK + osmolMg + osmolCa;
      
      const soluvitVolume = roundToPlace(Math.min(bw * 1, 10), 1);
      const peditraceVolume = roundToPlace(Math.min(bw * 1, 15), 1);
      document.getElementById('soluvit').value = soluvitVolume;
      document.getElementById('peditrace').value = peditraceVolume;
      document.getElementById('soluvitWarning').classList.toggle('hidden', !(bw * 1 > 10));
      document.getElementById('peditraceWarning').classList.toggle('hidden', !(bw * 1 > 15));
      
      const vitaminTraceVolume = soluvitVolume + peditraceVolume;
      
      let additivesVolume = 0;
      
      const isPreterm = document.getElementById('isPreterm').checked;
      const zincOptionsDiv = document.getElementById('zincOptions');
      zincOptionsDiv.classList.toggle('hidden', !isPreterm);
      
      if (isPreterm) {
        const zincSelection = document.querySelector('input[name="zinc"]:checked');
        if (zincSelection && zincSelection.value === 'yes') {
          const calculatedZincVol = 0.3 * bw;
          const zincVolumeInput = document.getElementById('zincVolume');
          if (document.activeElement !== zincVolumeInput) {
            zincVolumeInput.value = roundToPlace(calculatedZincVol, 2);
          }
          additivesVolume += parseFloat(zincVolumeInput.value) || 0;
          document.getElementById('zincVolumeDiv').classList.remove('hidden');
        } else {
          document.getElementById('zincVolumeDiv').classList.add('hidden');
        }
      }
      
      const heparinSelection = document.querySelector('input[name="heparin"]:checked');
      const route = document.querySelector('input[name="route"]:checked').value;
      if (route === 'central' && heparinSelection.value === 'no') {
        document.getElementById('heparinYes').checked = true;
      }
      
      let heparinVolume = 0;
      if (document.querySelector('input[name="heparin"]:checked').value === 'yes') {
        const hepUnits = 1 * pnVolume;
        document.getElementById('heparinUnits').textContent = roundToPlace(hepUnits, 0);
        heparinVolume = roundToPlace(roundToPlace(hepUnits, 0) / 500, 2);
        document.getElementById('heparinVolume').textContent = heparinVolume.toFixed(2);
        document.getElementById('heparinValueDiv').classList.remove('hidden');
      } else {
        document.getElementById('heparinValueDiv').classList.add('hidden');
      }
      
      const additiveOtherName = document.getElementById('additiveOtherName').value || '';
      const additiveOtherVolume = parseFloat(document.getElementById('additiveOtherVolume').value) || 0;
      if (additiveOtherName && additiveOtherVolume > 0) {
        additivesVolume += additiveOtherVolume;
      }
      
      additivesVolume += heparinVolume;
      
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked').value;
      const totalProteinGrams = bw * proteinTarget;
      let proteinVolume = 0;
      if (proteinProduct === 'aminoplasmal') {
        proteinVolume = totalProteinGrams / 0.15;
      } else {
        proteinVolume = totalProteinGrams * 10;
      }
      
      const proteinCalories = totalProteinGrams * 4;
      const proteinOsmol = pnVolume > 0 ? roundToPlace((totalProteinGrams * 10 * 1000) / pnVolume, 0) : 0;
      
      const dextroseVolume = roundToPlace((dextrosePercent * pnVolume * 2) / 100, 1);
      const dextroseGrams = roundToPlace((dextrosePercent * pnVolume) / 100, 1);
      const dextroseCalories = dextroseGrams * 3.4;
      const dextroseOsmol = pnVolume > 0 ? roundToPlace((dextroseGrams * 5 * 1000) / pnVolume, 0) : 0;
      
      const fatGrams = bw * netFat;
      const fatCalories = fatGrams * 10;
      
      // ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÉ‡∏ô additivesVolume ‡∏°‡∏µ heparin ‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      const allSubstancesVolume = proteinVolume + dextroseVolume + electrolytesVolume + vitaminTraceVolume + additivesVolume;
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡πÇ‡∏î‡∏¢‡πÄ‡∏≠‡∏≤ PN Volume ‡∏ï‡∏±‡πâ‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const waterVolume = Math.max(0, pnVolume - allSubstancesVolume);
      // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---
      
      // 1. Macronutrients
      document.getElementById('proteinVol').textContent = roundToPlace(proteinVolume, 1);
      document.getElementById('proteinCal').textContent = roundToPlace(proteinCalories, 1);
      document.getElementById('proteinOsmol').textContent = roundToPlace(proteinOsmol, 0);
      document.getElementById('dextroseVol').textContent = roundToPlace(dextroseVolume, 1);
      document.getElementById('dextroseCal').textContent = roundToPlace(dextroseCalories, 1);
      document.getElementById('dextroseOsmol').textContent = roundToPlace(dextroseOsmol, 0);

      // 2. Electrolytes (‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)
      document.getElementById('row-phos-vol').textContent = roundToPlace(phosVolume, 1);
      document.getElementById('row-phos-osmol').textContent = 0; // Glycophos ‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î osmol ‡∏´‡∏•‡∏±‡∏Å
      document.getElementById('row-na-vol').textContent = roundToPlace(naClVolume, 1);
      document.getElementById('row-na-osmol').textContent = roundToPlace(osmolNa, 0);
      document.getElementById('row-k-vol').textContent = roundToPlace(kVolume, 1);
      document.getElementById('row-k-osmol').textContent = roundToPlace(osmolK, 0);
      document.getElementById('row-mg-vol').textContent = roundToPlace(mgVolume, 2);
      document.getElementById('row-mg-osmol').textContent = roundToPlace(osmolMg, 0);
      document.getElementById('row-ca-vol').textContent = roundToPlace(caVolume, 1);
      document.getElementById('row-ca-osmol').textContent = roundToPlace(osmolCa, 0);

      // 3. Vitamins & Trace
      document.getElementById('row-soluvit-vol').textContent = roundToPlace(soluvitVolume, 1);
      document.getElementById('row-peditrace-vol').textContent = roundToPlace(peditraceVolume, 1);

      // 4. Additives
      document.getElementById('row-zinc-vol').textContent = isPreterm ? roundToPlace(parseFloat(document.getElementById('zincVolume').value) || 0, 2) : "0.0";
      document.getElementById('row-heparin-vol').textContent = roundToPlace(heparinVolume, 2);
      document.getElementById('row-other-name').textContent = "- " + (additiveOtherName || "Other Additive");
      document.getElementById('row-other-vol').textContent = roundToPlace(additiveOtherVolume, 1);

      // 5. Water & Totals
      document.getElementById('waterVol').textContent = roundToPlace(waterVolume, 1);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á PN Bag)
      const finalPNVol = proteinVolume + dextroseVolume + electrolytesVolume + vitaminTraceVolume + additivesVolume + waterVolume;
      const finalPNCal = proteinCalories + dextroseCalories;
      const finalOsmol = proteinOsmol + dextroseOsmol + electrolytesOsmol;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ô‡πâ‡∏≥‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ 51.67 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
      document.getElementById('waterVol').textContent = roundToPlace(waterVolume, 2);

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö pnVolume ‡πÄ‡∏™‡∏°‡∏≠
      const finalTotalPN = allSubstancesVolume + waterVolume;
      const totalPNCal = proteinCalories + dextroseCalories;
      const totalOsmolarity = proteinOsmol + dextroseOsmol + electrolytesOsmol;
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î "‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ PN Bag"
      document.getElementById('totalPNVol').textContent = roundToPlace(finalTotalPN, 1);
      document.getElementById('totalPNCal').textContent = roundToPlace(totalPNCal, 1);
      document.getElementById('totalOsmol').textContent = roundToPlace(totalOsmolarity, 0);
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      document.getElementById('totalCalDisplay').textContent = roundToPlace(finalPNCal + fatCalories, 1);
      document.getElementById('calPerKg').textContent = bw > 0 ? roundToPlace((finalPNCal + fatCalories) / bw, 1) : '0.0';
      document.getElementById('finalOsmol').textContent = roundToPlace(finalOsmol, 0);

      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Osmolarity
      const osmolWarning = document.getElementById('osmolWarning');
      if (route === 'peripheral' && finalOsmol > 900) {
        osmolWarning.classList.remove('hidden');
      } else {
        osmolWarning.classList.add('hidden');
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
      calculateFatAdmin();
      updateOrderSummary();
    } // <--- ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô calculateAll

    function calculateFatAdmin() {
  // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Volume ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
  const fatVolume = parseFloat(document.getElementById('fatVolume').value) || 0;
  const vitalipidVolume = parseFloat(document.getElementById('vitalipid').value) || 0;
  const flushOption = document.querySelector('input[name="flush"]:checked').value;
  const flushVolume = flushOption === 'custom' ? (parseFloat(document.getElementById('flushVolume').value) || 0) : 0;
  
  const prepSplit = document.querySelector('input[name="prepSplit"]:checked').value;
  const manualRate = document.getElementById('manualFatDripRate').value || '0.0';
  
  // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏° Volume ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  const totalVolPlusFlush = fatVolume + flushVolume; // Fat + ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢
  const grandTotalFatVit = totalVolPlusFlush + vitalipidVolume; // ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  
  // 3. ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "Total Volume Fat + Vitalipid"
  document.getElementById('totalFatPlusVitalipid').value = roundToPlace(grandTotalFatVit, 1);
  
  // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Fat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
  let prepText = `
    <p>‚Ä¢ Fat Volume ‡∏£‡∏ß‡∏°‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢: <strong>${roundToPlace(totalVolPlusFlush, 1)}</strong> ml</p>
    <p>‚Ä¢ Vitalipid¬Æ: <strong>${roundToPlace(vitalipidVolume, 1)}</strong> ml</p>
    <p>‚Ä¢ Total Volume Fat + ‡πÑ‡∏•‡πà‡∏™‡∏≤‡∏¢ + Vitalipid: <span class="text-lg font-bold">${roundToPlace(grandTotalFatVit, 1)}</span> ml</p>
  `;
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°
  if (prepSplit === 'split') {
    const splitValue = grandTotalFatVit / 2;
    prepText += `<p>‚Ä¢ <strong>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</strong> ${roundToPlace(splitValue, 1)} ml √ó 2 syringe/‡∏Ç‡∏ß‡∏î</p>`;
  } else {
    prepText += `<p>‚Ä¢ <strong>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°:</strong> ‡πÑ‡∏°‡πà‡πÅ‡∏ö‡πà‡∏á</p>`;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á Drip Rate ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
  prepText += `<p>‚Ä¢ <strong>Drip Rate:</strong> <span class="text-blue-700 font-bold">${manualRate}</span> ml/hr</p>`;
  
  // ‡∏û‡πà‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  document.getElementById('prepDetails').innerHTML = prepText;

  // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å] ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ Order ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (typeof updateOrderSummary === "function") {
    updateOrderSummary();
  }
}

    function updateOrderSummary() {
      const orderDate = document.getElementById('orderDate').value;
      const hn = document.getElementById('hn').value || '-';
      const patientName = document.getElementById('patientName').value || '-';
      const ward = document.getElementById('ward').value || '-';
      const route = document.querySelector('input[name="route"]:checked').value;
      const bw = parseFloat(document.getElementById('bw').value) || 0;
      const pnVolume = parseFloat(document.getElementById('pnVolume').value) || 0;
      const rateTPN = parseFloat(document.getElementById('rateTPN').value) || 0;
      const proteinTarget = parseFloat(document.getElementById('proteinTarget').value) || 0;
      const netFat = parseFloat(document.getElementById('netFat').value) || 0;
      const dextrosePercent = parseFloat(document.getElementById('dextrosePercent').value) || 0;
      const gir = parseFloat(document.getElementById('girValue').textContent) || 0;
      const vitalipid = parseFloat(document.getElementById('vitalipid').value) || 0;
      const proteinProduct = document.querySelector('input[name="proteinProduct"]:checked');
      const fatProduct = document.querySelector('input[name="fatProduct"]:checked');
      const totalCal = parseFloat(document.getElementById('totalCalDisplay').textContent) || 0;
      const calPerKg = parseFloat(document.getElementById('calPerKg').textContent) || 0;
      
      const proteinProductName = proteinProduct.parentElement.querySelector('.font-medium').textContent;
      const fatProductName = fatProduct.parentElement.querySelector('.font-medium').textContent;
      
      const formattedDate = orderDate ? new Date(orderDate).toLocaleDateString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      }) : '-';
      
      const summaryHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <p><span class="text-blue-200">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span> ${formattedDate}</p>
            <p><span class="text-blue-200">üè• HN:</span> ${hn}</p>
            <p><span class="text-blue-200">üë§ ‡∏ä‡∏∑‡πà‡∏≠:</span> ${patientName}</p>
            <p><span class="text-blue-200">üõèÔ∏è Ward:</span> ${ward}</p>
            <p><span class="text-blue-200">üíâ Route:</span> ${route === 'central' ? 'Central Line' : 'Peripheral Line'}</p>
          </div>
          <div class="space-y-2">
            <p><span class="text-blue-200">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</span> ${bw} kg</p>
            <p><span class="text-blue-200">üíß PN Volume:</span> ${roundToPlace(pnVolume, 1)} ml</p>
            <p><span class="text-blue-200">‚è±Ô∏è Rate:</span> ${roundToPlace(rateTPN, 1)} ml/hr</p>
            <p><span class="text-blue-200">üî• Total Cal:</span> ${roundToPlace(totalCal, 1)} kcal (${roundToPlace(calPerKg, 1)} kcal/kg/day)</p>
          </div>
        </div>
        <hr class="border-blue-400/30 my-3">
        <div class="space-y-2">
          <p><span class="text-blue-200">ü•© Protein:</span> ${proteinTarget} g/kg/day (${proteinProductName})</p>
          <p><span class="text-blue-200">üßà Fat:</span> ${roundToPlace(netFat, 1)} g/kg/day (${fatProductName})</p>
          <p><span class="text-blue-200">üç¨ Dextrose:</span> ${dextrosePercent}%</p>
          <p><span class="text-blue-200">üìä GIR:</span> ${roundToPlace(gir, 2)} mg/kg/min</p>
          <p><span class="text-blue-200">üíä Vitalipid-N Infant:</span> ${roundToPlace(vitalipid, 1)} ml</p>
        </div>
      `;
      
      document.getElementById('orderSummary').innerHTML = summaryHTML;
    }

    function resetForm() {
  // 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
  document.getElementById('orderDate').valueAsDate = new Date();
  document.getElementById('hn').value = '';
  document.getElementById('patientName').value = '';
  document.getElementById('wardInput').value = ''; 
  document.getElementById('ward').value = '';      

  // 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Manual ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ Fat ‡∏Ç‡∏≠‡∏á Vitalipid (‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
  isVitalipidManual = false; 
  document.getElementById('vitalipidFatValue').value = "0.4";
  document.getElementById('deductVitalipid').checked = false;

  // 3. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  document.getElementById('bw').value = '';
  document.getElementById('totalVolume').value = '';
  document.getElementById('fatTarget').value = '';
  document.getElementById('proteinTarget').value = '';
  document.getElementById('dextrosePercent').value = '';
  document.getElementById('flushVolume').value = '';
  document.getElementById('phosphorus').value = '';
  document.getElementById('sodium').value = '';
  document.getElementById('potassium').value = '';
  document.getElementById('magnesium').value = '';
  document.getElementById('calcium').value = '';
  document.getElementById('isPreterm').checked = false;
  document.getElementById('additiveOtherName').value = '';
  document.getElementById('additiveOtherVolume').value = '';
  
  // 4. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Radio Buttons
  document.querySelector('input[name="route"][value="central"]').checked = true;
  document.querySelector('input[name="proteinProduct"][value="aminoven"]').checked = true;
  document.querySelector('input[name="fatProduct"][value="smof"]').checked = true;
  document.querySelector('input[name="flush"][value="none"]').checked = true;
  document.querySelector('input[name="dripDuration"][value="12"]').checked = true;
  document.querySelector('input[name="prepSplit"][value="none"]').checked = true;
  document.querySelector('input[name="heparin"][value="no"]').checked = true;
  document.querySelector('input[name="zinc"][value="no"]').checked = true;
  document.getElementById('pnFlushVolume').value = 30; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

  
  // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏∞‡∏≠‡∏≤‡∏î
  calculateAll();
}

    // ========== Event Listeners ==========

    document.querySelectorAll('input[name="route"]').forEach(radio => {
      radio.addEventListener('change', calculateAll);
    });

    // ========== Initialize ==========

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ TPN Calculator ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      console.log('üì° ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö:', API_URL);
      document.getElementById('orderDate').valueAsDate = new Date();
      calculateAll();
    });
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ Vitalipid ‡πÄ‡∏≠‡∏á ---
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ Vitalipid ‡πÄ‡∏≠‡∏á
function handleVitalipidManualChange() {
  isVitalipidManual = true; 
  calculateAll();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤ Rate ‡πÄ‡∏≠‡∏á
function handleRateManualChange() {
  isRateManual = true; 
  calculateAll();
}
  </script>
</body>
</html>

